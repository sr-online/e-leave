<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ - ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/admin-dashboard-enhanced.css">
    <style>
        /* Additional styles for staff management page */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .action-card {
            background: linear-gradient(135deg, var(--surface) 0%, #fafbff 100%);
            padding: 30px;
            border-radius: 20px;
            border: 2px solid var(--border-light);
            transition: all var(--transition);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .action-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            transform: scaleX(0);
            transition: transform var(--transition);
        }

        .action-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary);
        }

        .action-card:hover::before {
            transform: scaleX(1);
        }

        .action-card.leave::before {
            background: linear-gradient(90deg, #ef4444, #f87171);
        }

        .action-card.trip::before {
            background: linear-gradient(90deg, #06b6d4, #22d3ee);
        }

        .action-card.late::before {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
        }

        .action-icon {
            font-size: 3.5rem;
            margin-bottom: 15px;
            display: block;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));
        }

        .action-title {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text);
        }

        .action-desc {
            font-size: 0.95rem;
            color: var(--text-light);
            line-height: 1.6;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            z-index: 10000;
            padding: 20px;
            overflow-y: auto;
            animation: fadeIn 0.3s ease-out;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--surface);
            border-radius: 24px;
            padding: 40px;
            max-width: 700px;
            width: 100%;
            position: relative;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.4s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--primary-ultra-light);
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .modal-close {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--border-light);
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text);
        }

        .modal-close:hover {
            background: var(--danger);
            color: white;
            transform: rotate(90deg);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-help {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .success-message,
        .error-message {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            animation: slideDown 0.3s ease-out;
        }

        .success-message {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border-left: 5px solid var(--success);
        }

        .error-message {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border-left: 5px solid var(--danger);
        }

        .success-message.show,
        .error-message.show {
            display: flex;
        }

        .btn-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .btn-cancel {
            background: var(--border-light);
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-cancel:hover {
            background: var(--border);
            transform: translateY(-2px);
        }

        .leave-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
            margin-top: 10px;
        }

        .leave-type-option {
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all var(--transition);
            text-align: center;
            background: var(--surface);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .leave-type-option:hover {
            border-color: var(--primary);
            background: var(--primary-ultra-light);
            transform: translateY(-2px);
        }

        .leave-type-option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: var(--shadow-primary);
        }

        .leave-type-icon {
            font-size: 2rem;
        }

        .leave-type-name {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .info-box {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            padding: 16px 20px;
            border-radius: 12px;
            border-left: 5px solid var(--info);
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .info-box-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .info-box-text {
            font-size: 0.9rem;
            color: #1e3a8a;
            line-height: 1.6;
        }

        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.6s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .recent-entries {
            margin-top: 40px;
        }

        .entry-item {
            background: var(--surface);
            padding: 20px;
            border-radius: 14px;
            margin-bottom: 12px;
            border-left: 5px solid var(--primary);
            transition: all var(--transition);
            cursor: pointer;
        }

        .entry-item:hover {
            transform: translateX(5px);
            box-shadow: var(--shadow-md);
        }

        .entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .entry-type {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .entry-type.leave {
            background: var(--danger-bg);
            color: #991b1b;
        }

        .entry-type.trip {
            background: var(--info-bg);
            color: #1e3a8a;
        }

        .entry-type.late {
            background: var(--warning-bg);
            color: #92400e;
        }

        .entry-name {
            font-weight: 600;
            font-size: 1.05rem;
            color: var(--text);
            margin-bottom: 6px;
        }

        .entry-details {
            font-size: 0.9rem;
            color: var(--text-light);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 30px 20px;
            }

            .leave-type-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            }
        }
    </style>
</head>
<body>
    <button class="menu-toggle" onclick="toggleMenu()">‚ò∞</button>

    <div class="sidebar" id="sidebar">
        <div class="logo">üë®‚Äçüíº ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</div>
        <nav>
            <div class="nav-item active" onclick="location.href='staff-management.html'">
                <span class="nav-icon">üìù</span>
                <span>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
            </div>
            <div class="nav-item" onclick="location.href='admin-dashboard.html'">
                <span class="nav-icon">üìä</span>
                <span>‡∏Å‡∏•‡∏±‡∏ö‡∏™‡∏π‡πà‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</span>
            </div>
            <div class="nav-item" onclick="logout()">
                <span class="nav-icon">üö™</span>
                <span>‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span>
            </div>
        </nav>
    </div>

    <div class="main-content">
        <div class="content-wrapper">
            <div class="top-bar">
                <h1 class="page-title">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</h1>
                <div class="admin-info">
                    <div class="admin-avatar">‡πÄ</div>
                    <div>
                        <div style="font-weight: 600; font-size: 1.05rem;">‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏•‡∏≤</div>
                        <div style="font-size: 0.9rem; color: var(--text-light);">Staff</div>
                    </div>
                </div>
            </div>

            <div class="info-box">
                <span class="info-box-icon">‚ÑπÔ∏è</span>
                <div class="info-box-text">
                    <strong>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà:</strong> ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤ ‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <div class="action-card leave" onclick="openModal('leave')">
                    <span class="action-icon">üìã</span>
                    <h3 class="action-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏•‡∏≤</h3>
                    <p class="action-desc">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤ ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏¥‡∏™‡∏£‡∏∞</p>
                </div>

                <div class="action-card trip" onclick="openModal('trip')">
                    <span class="action-icon">üöó</span>
                    <h3 class="action-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</h3>
                    <p class="action-desc">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ ‡∏≠‡∏ö‡∏£‡∏° ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏Ç‡∏≠‡∏á‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</p>
                </div>

                <div class="action-card late" onclick="openModal('late')">
                    <span class="action-icon">‚è∞</span>
                    <h3 class="action-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢</h3>
                    <p class="action-desc">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏ß‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</p>
                </div>
            </div>

            <!-- Recent Entries -->
            <div class="recent-entries">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                        <button class="btn btn-secondary" onclick="loadRecentEntries()">
                            üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                        </button>
                    </div>
                    <div id="recentEntriesList">
                        <div style="text-align: center; padding: 60px 20px; color: var(--text-light);">
                            <div style="font-size: 3rem; margin-bottom: 15px;">üìä</div>
                            <div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Leave Modal -->
    <div id="leaveModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span>üìã</span>
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏•‡∏≤
                </h2>
                <button class="modal-close" onclick="closeModal('leave')">√ó</button>
            </div>

            <div id="leaveSuccessMessage" class="success-message">
                <span>‚úÖ</span>
                <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</span>
            </div>

            <div id="leaveErrorMessage" class="error-message">
                <span>‚ùå</span>
                <span id="leaveErrorText">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</span>
            </div>

            <form id="leaveForm">
                <div class="form-group">
                    <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ *</label>
                    <select id="leaveUserId" class="form-control" required>
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ --</option>
                    </select>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤ *</label>
                    <div class="leave-type-grid" id="leaveTypeGrid">
                        <!-- Will be populated by JavaScript -->
                    </div>
                    <input type="hidden" id="leaveType" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô *</label>
                        <input type="date" id="leaveStartDate" class="form-control" required>
                        <div class="form-help">üí° ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î *</label>
                        <input type="date" id="leaveEndDate" class="form-control" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô *</label>
                    <input type="number" id="leaveDays" class="form-control" min="0.5" step="0.5" required>
                    <div class="form-help">üí° ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏õ‡πá‡∏ô 0.5 ‡∏ß‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏∂‡πà‡∏á‡∏ß‡∏±‡∏ô</div>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</label>
                    <textarea id="leaveReason" class="form-control" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ *</label>
                    <select id="leaveStatus" class="form-control" required>
                        <option value="approved">‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß</option>
                        <option value="pending">‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                        <option value="rejected">‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥</option>
                    </select>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn btn-cancel" onclick="closeModal('leave')">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Trip Modal -->
    <div id="tripModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span>üöó</span>
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£
                </h2>
                <button class="modal-close" onclick="closeModal('trip')">√ó</button>
            </div>

            <div id="tripSuccessMessage" class="success-message">
                <span>‚úÖ</span>
                <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</span>
            </div>

            <div id="tripErrorMessage" class="error-message">
                <span>‚ùå</span>
                <span id="tripErrorText">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</span>
            </div>

            <form id="tripForm">
                <div class="form-group">
                    <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ *</label>
                    <select id="tripUserId" class="form-control" required>
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ --</option>
                    </select>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠/‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á *</label>
                    <input type="text" id="tripSubject" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£, ‡∏≠‡∏ö‡∏£‡∏°‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°" required>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà *</label>
                    <input type="text" id="tripLocation" class="form-control" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏û‡∏°.33, ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô *</label>
                        <input type="date" id="tripStartDate" class="form-control" required>
                        <div class="form-help">üí° ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                        <input type="date" id="tripEndDate" class="form-control">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô *</label>
                    <input type="number" id="tripDays" class="form-control" min="0.5" step="0.5" value="1" required>
                </div>

                <div class="form-group">
                    <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏≠‡∏ö‡∏£‡∏°</label>
                    <select id="tripTrainingType" class="form-control">
                        <option value="">-- ‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏ --</option>
                        <option value="‡∏≠‡∏ö‡∏£‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡∏ô‡πÄ‡∏≠‡∏á">‡∏≠‡∏ö‡∏£‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</option>
                        <option value="‡∏≠‡∏ö‡∏£‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö">‡∏≠‡∏ö‡∏£‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</option>
                        <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                    </select>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå</label>
                    <textarea id="tripNotes" class="form-control" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£/‡∏≠‡∏ö‡∏£‡∏°"></textarea>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn btn-cancel" onclick="closeModal('trip')">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Late Arrival Modal -->
    <div id="lateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">
                    <span>‚è∞</span>
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢
                </h2>
                <button class="modal-close" onclick="closeModal('late')">√ó</button>
            </div>

            <div id="lateSuccessMessage" class="success-message">
                <span>‚úÖ</span>
                <span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</span>
            </div>

            <div id="lateErrorMessage" class="error-message">
                <span>‚ùå</span>
                <span id="lateErrorText">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</span>
            </div>

            <form id="lateForm">
                <div class="form-group">
                    <label class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ *</label>
                    <select id="lateUserId" class="form-control" required>
                        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ --</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà *</label>
                        <input type="date" id="lateDate" class="form-control" required>
                        <div class="form-help">üí° ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ</div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏ñ‡∏∂‡∏á *</label>
                        <input type="time" id="lateTime" class="form-control" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢ (‡∏ô‡∏≤‡∏ó‡∏µ) *</label>
                    <input type="number" id="lateMinutes" class="form-control" min="1" placeholder="‡πÄ‡∏ä‡πà‡∏ô 15, 30" required>
                </div>

                <div class="form-group full-width">
                    <label class="form-label">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</label>
                    <textarea id="lateReason" class="form-control" rows="3" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)"></textarea>
                </div>

                <div class="btn-group">
                    <button type="button" class="btn btn-cancel" onclick="closeModal('late')">
                        ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        ‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, doc, getDoc, updateDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDYxyr-KArgycFagZjgJLYGQppSM9Trz2U",
            authDomain: "e-leave-2a711.firebaseapp.com",
            projectId: "e-leave-2a711",
            storageBucket: "e-leave-2a711.firebasestorage.app",
            messagingSenderId: "600657791927",
            appId: "1:600657791927:web:da2848098c2844a0e47632",
            measurementId: "G-STGXNL3YLG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Check authentication
        const currentAdminData = sessionStorage.getItem('currentAdmin');
        if (!currentAdminData) {
            window.location.href = 'admin-login.html';
        }

        // Leave types configuration
        const leaveTypes = [
            { id: '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', icon: 'üè•', name: '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢' },
            { id: '‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£', icon: 'üë∂', name: '‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£' },
            { id: '‡∏•‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏†‡∏£‡∏¥‡∏¢‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£', icon: 'ü§±', name: '‡∏ä‡πà‡∏ß‡∏¢‡∏†‡∏£‡∏¥‡∏¢‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î' },
            { id: '‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß', icon: 'üìù', name: '‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß' },
            { id: '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô', icon: 'üèñÔ∏è', name: '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô' },
            { id: '‡∏•‡∏≤‡∏≠‡∏∏‡∏õ‡∏™‡∏°‡∏ö‡∏ó', icon: 'üôè', name: '‡∏•‡∏≤‡∏≠‡∏∏‡∏õ‡∏™‡∏°‡∏ö‡∏ó' },
            { id: '‡∏•‡∏≤‡∏®‡∏∂‡∏Å‡∏©‡∏≤', icon: 'üìö', name: '‡∏•‡∏≤‡∏®‡∏∂‡∏Å‡∏©‡∏≤' },
            { id: '‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®', icon: 'üåè', name: '‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®' },
            { id: '‡∏•‡∏≤‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏†‡∏≤‡∏û', icon: 'üí™', name: '‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏†‡∏≤‡∏û' },
            { id: '‡∏•‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™', icon: '‚úàÔ∏è', name: '‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™' },
            { id: '‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô', icon: 'üèõÔ∏è', name: '‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô' }
        ];

        // Global functions
        window.toggleMenu = function() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('mobile-show');
        };

        window.logout = function() {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                sessionStorage.removeItem('currentAdmin');
                window.location.href = 'admin-login.html';
            }
        };

        window.openModal = function(type) {
            const modal = document.getElementById(`${type}Modal`);
            modal.classList.add('show');
        };

        window.closeModal = function(type) {
            const modal = document.getElementById(`${type}Modal`);
            modal.classList.remove('show');
            
            // Reset form
            document.getElementById(`${type}Form`).reset();
            
            // Hide messages
            document.getElementById(`${type}SuccessMessage`).classList.remove('show');
            document.getElementById(`${type}ErrorMessage`).classList.remove('show');
            
            // Reset leave type selection
            if (type === 'leave') {
                document.querySelectorAll('.leave-type-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
            }
        };

        // Initialize
        async function initialize() {
            await loadUsers();
            renderLeaveTypes();
            await loadRecentEntries();
            setupFormHandlers();
        }

        // Load users
        async function loadUsers() {
            try {
                const usersSnapshot = await getDocs(collection(db, 'users'));
                const users = [];
                
                usersSnapshot.forEach(doc => {
                    users.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Sort by name
                users.sort((a, b) => a.name.localeCompare(b.name));

                // Populate user selects
                ['leaveUserId', 'tripUserId', 'lateUserId'].forEach(selectId => {
                    const select = document.getElementById(selectId);
                    select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£ --</option>';
                    
                    users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user.id;
                        option.textContent = `${user.name} (${user.position || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á'})`;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }

        // Render leave types
        function renderLeaveTypes() {
            const grid = document.getElementById('leaveTypeGrid');
            grid.innerHTML = '';

            leaveTypes.forEach(type => {
                const option = document.createElement('div');
                option.className = 'leave-type-option';
                option.innerHTML = `
                    <span class="leave-type-icon">${type.icon}</span>
                    <span class="leave-type-name">${type.name}</span>
                `;
                
                option.addEventListener('click', () => {
                    document.querySelectorAll('.leave-type-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    option.classList.add('selected');
                    document.getElementById('leaveType').value = type.id;
                });

                grid.appendChild(option);
            });
        }

        // Load recent entries
        window.loadRecentEntries = async function() {
            try {
                const recentList = document.getElementById('recentEntriesList');
                recentList.innerHTML = '<div style="text-align: center; padding: 40px;"><div class="loading"></div></div>';

                const entries = [];

                // Load recent leaves
                const leavesQuery = query(collection(db, 'leaves'), orderBy('submittedDate', 'desc'), limit(10));
                const leavesSnapshot = await getDocs(leavesQuery);
                leavesSnapshot.forEach(doc => {
                    const data = doc.data();
                    entries.push({
                        id: doc.id,
                        entryType: 'leave',
                        leaveType: data.type,  // This is the actual leave type (‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢, etc.)
                        ...data
                    });
                });

                // Load recent trips
                const tripsQuery = query(collection(db, 'official_trips'), orderBy('submittedDate', 'desc'), limit(10));
                const tripsSnapshot = await getDocs(tripsQuery);
                tripsSnapshot.forEach(doc => {
                    entries.push({
                        id: doc.id,
                        entryType: 'trip',
                        ...doc.data()
                    });
                });

                // Load recent late arrivals
                const latesQuery = query(collection(db, 'late_arrivals'), orderBy('submittedDate', 'desc'), limit(10));
                const latesSnapshot = await getDocs(latesQuery);
                latesSnapshot.forEach(doc => {
                    entries.push({
                        id: doc.id,
                        entryType: 'late',
                        ...doc.data()
                    });
                });

                // Sort by date
                entries.sort((a, b) => {
                    const dateA = a.submittedDate || a.createdAt || '';
                    const dateB = b.submittedDate || b.createdAt || '';
                    return dateB.localeCompare(dateA);
                });

                // Display
                if (entries.length === 0) {
                    recentList.innerHTML = `
                        <div style="text-align: center; padding: 60px 20px; color: var(--text-light);">
                            <div style="font-size: 3rem; margin-bottom: 15px;">üìä</div>
                            <div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°</div>
                        </div>
                    `;
                    return;
                }

                recentList.innerHTML = entries.slice(0, 20).map(entry => {
                    let typeLabel, typeClass, details;
                    
                    if (entry.entryType === 'leave') {
                        typeLabel = '‡∏Å‡∏≤‡∏£‡∏•‡∏≤';
                        typeClass = 'leave';
                        const leaveTypeName = entry.leaveType || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                        const statusText = entry.status || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞';
                        details = `${leaveTypeName} | ${entry.startDate} - ${entry.endDate} | ${entry.days} ‡∏ß‡∏±‡∏ô | ${statusText}`;
                    } else if (entry.entryType === 'trip') {
                        typeLabel = '‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£';
                        typeClass = 'trip';
                        const purposeText = entry.purpose || entry.notes || '-';
                        const statusText = entry.status || '‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß';
                        details = `${entry.subject} | ${entry.location} | ${entry.startDate || entry.date} | ${statusText}`;
                    } else {
                        typeLabel = '‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢';
                        typeClass = 'late';
                        const timeText = entry.arrivalTime || entry.time || '-';
                        const statusText = entry.status || '‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß';
                        details = `${entry.date} | ${timeText} | ${entry.minutes} ‡∏ô‡∏≤‡∏ó‡∏µ | ${statusText}`;
                    }

                    const displayDate = entry.submittedDate || entry.createdAt;
                    const formattedDate = displayDate ? new Date(displayDate).toLocaleDateString('th-TH') : '-';

                    return `
                        <div class="entry-item">
                            <div class="entry-header">
                                <span class="entry-type ${typeClass}">${typeLabel}</span>
                                <span style="font-size: 0.85rem; color: var(--text-light);">
                                    ${formattedDate}
                                </span>
                            </div>
                            <div class="entry-name">${entry.userName || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠'}</div>
                            <div class="entry-details">${details}</div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading recent entries:', error);
                document.getElementById('recentEntriesList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--danger);">
                        ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </div>
                `;
            }
        };

        // Setup form handlers
        function setupFormHandlers() {
            // Leave form
            document.getElementById('leaveForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await handleLeaveSubmit();
            });

            // Trip form
            document.getElementById('tripForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await handleTripSubmit();
            });

            // Late form
            document.getElementById('lateForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await handleLateSubmit();
            });

            // Auto-calculate leave days
            document.getElementById('leaveStartDate').addEventListener('change', calculateLeaveDays);
            document.getElementById('leaveEndDate').addEventListener('change', calculateLeaveDays);

            // Auto-calculate trip days
            document.getElementById('tripStartDate').addEventListener('change', calculateTripDays);
            document.getElementById('tripEndDate').addEventListener('change', calculateTripDays);
        }

        function calculateLeaveDays() {
            const startDate = document.getElementById('leaveStartDate').value;
            const endDate = document.getElementById('leaveEndDate').value;

            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                document.getElementById('leaveDays').value = diffDays;
            }
        }

        function calculateTripDays() {
            const startDate = document.getElementById('tripStartDate').value;
            const endDate = document.getElementById('tripEndDate').value;

            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const diffTime = Math.abs(end - start);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                document.getElementById('tripDays').value = diffDays;
            }
        }

        // Handle leave submit
        async function handleLeaveSubmit() {
            const submitBtn = document.querySelector('#leaveForm button[type="submit"]');
            
            try {
                // Disable button to prevent double submission
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="loading-spinner"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                
                const userId = document.getElementById('leaveUserId').value;
                const leaveType = document.getElementById('leaveType').value;
                const startDate = document.getElementById('leaveStartDate').value;
                const endDate = document.getElementById('leaveEndDate').value;
                const days = parseFloat(document.getElementById('leaveDays').value);
                const reason = document.getElementById('leaveReason').value;
                const status = document.getElementById('leaveStatus').value;

                if (!leaveType) {
                    showError('leave', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                    return;
                }

                // Get user data
                const userDoc = await getDoc(doc(db, 'users', userId));
                const userData = userDoc.data();

                // Add leave to database - match teacher-leave.html structure
                await addDoc(collection(db, 'leaves'), {
                    userId: userId,
                    userName: userData.name,
                    userPosition: userData.position || '',  // Add position field
                    type: leaveType,
                    startDate: startDate,
                    endDate: endDate,
                    days: days,
                    reason: reason || '-',
                    phone: userData.phone || '',  // Add phone field
                    status: status === 'approved' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : status === 'pending' ? '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' : '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                    submittedDate: new Date().toISOString(),
                    createdAt: new Date().toISOString(),
                    createdBy: 'staff',
                    addedByStaff: true
                });

                // Update user leave balance if approved
                if (status === 'approved') {
                    await updateUserLeaveBalance(userId, leaveType, days);
                }

                // Close modal immediately
                closeModal('leave');
                
                // Show success message in main page
                alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                
                // Reload recent entries
                loadRecentEntries();

            } catch (error) {
                console.error('Error adding leave:', error);
                showError('leave', error.message);
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            }
        }

        // Handle trip submit
        async function handleTripSubmit() {
            const submitBtn = document.querySelector('#tripForm button[type="submit"]');
            
            try {
                // Disable button to prevent double submission
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="loading-spinner"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                
                const userId = document.getElementById('tripUserId').value;
                const subject = document.getElementById('tripSubject').value;
                const location = document.getElementById('tripLocation').value;
                const startDate = document.getElementById('tripStartDate').value;
                const endDate = document.getElementById('tripEndDate').value || startDate;
                const days = parseFloat(document.getElementById('tripDays').value);
                const trainingType = document.getElementById('tripTrainingType').value;
                const purpose = document.getElementById('tripNotes').value;  // Changed from notes to purpose

                // Get user data
                const userDoc = await getDoc(doc(db, 'users', userId));
                const userData = userDoc.data();

                // Add trip to database - match teacher-leave.html structure
                await addDoc(collection(db, 'official_trips'), {
                    userId: userId,
                    userName: userData.name,
                    trainingType: trainingType || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ',
                    subject: subject,
                    location: location,
                    startDate: startDate,
                    endDate: endDate,
                    date: startDate,  // For compatibility
                    days: days,
                    purpose: purpose || '-',  // Use purpose instead of notes
                    status: '‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß',  // Match teacher-leave.html
                    submittedDate: new Date().toISOString(),
                    createdAt: new Date().toISOString(),
                    createdBy: 'staff',
                    addedByStaff: true
                });

                // Close modal immediately
                closeModal('trip');
                
                // Show success message
                alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                
                // Reload recent entries
                loadRecentEntries();

            } catch (error) {
                console.error('Error adding trip:', error);
                showError('trip', error.message);
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            }
        }

        // Handle late submit
        async function handleLateSubmit() {
            const submitBtn = document.querySelector('#lateForm button[type="submit"]');
            
            try {
                // Disable button to prevent double submission
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="loading-spinner"></span> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
                
                const userId = document.getElementById('lateUserId').value;
                const date = document.getElementById('lateDate').value;
                const arrivalTime = document.getElementById('lateTime').value;  // Changed from time to arrivalTime
                const minutes = parseInt(document.getElementById('lateMinutes').value);
                const reason = document.getElementById('lateReason').value;

                // Get user data
                const userDoc = await getDoc(doc(db, 'users', userId));
                const userData = userDoc.data();

                // Add late arrival to database - match teacher-leave.html structure
                await addDoc(collection(db, 'late_arrivals'), {
                    userId: userId,
                    userName: userData.name,
                    date: date,
                    arrivalTime: arrivalTime,  // Use arrivalTime instead of time
                    time: arrivalTime,  // Keep time for backward compatibility
                    minutes: minutes,
                    reason: reason || '-',
                    status: '‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß',  // Match teacher-leave.html
                    submittedDate: new Date().toISOString(),
                    createdAt: new Date().toISOString(),
                    createdBy: 'staff',
                    addedByStaff: true
                });

                // Close modal immediately
                closeModal('late');
                
                // Show success message
                alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
                
                // Reload recent entries
                loadRecentEntries();

            } catch (error) {
                console.error('Error adding late arrival:', error);
                showError('late', error.message);
            } finally {
                // Re-enable button
                submitBtn.disabled = false;
                submitBtn.innerHTML = '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            }
        }

        // Update user leave balance
        async function updateUserLeaveBalance(userId, leaveType, days) {
            try {
                const userRef = doc(db, 'users', userId);
                const userDoc = await getDoc(userRef);
                
                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const updates = {};

                    // Calculate remaining leave
                    switch(leaveType) {
                        case '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢':
                            updates.sickLeaveRemaining = Math.max(0, (userData.sickLeaveRemaining || 30) - days);
                            break;
                        case '‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£':
                            updates.maternityLeaveRemaining = Math.max(0, (userData.maternityLeaveRemaining || 90) - days);
                            break;
                        case '‡∏•‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏†‡∏£‡∏¥‡∏¢‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£':
                            updates.helpWifeLeaveRemaining = Math.max(0, (userData.helpWifeLeaveRemaining || 15) - days);
                            break;
                        case '‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß':
                            updates.personalLeaveRemaining = Math.max(0, (userData.personalLeaveRemaining || 45) - days);
                            break;
                        case '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô':
                            updates.vacationLeaveRemaining = Math.max(0, (userData.vacationLeaveRemaining || 10) - days);
                            break;
                        case '‡∏•‡∏≤‡∏≠‡∏∏‡∏õ‡∏™‡∏°‡∏ö‡∏ó':
                            updates.ordinationLeaveRemaining = Math.max(0, (userData.ordinationLeaveRemaining || 120) - days);
                            break;
                        case '‡∏•‡∏≤‡∏®‡∏∂‡∏Å‡∏©‡∏≤':
                            updates.studyLeaveRemaining = Math.max(0, (userData.studyLeaveRemaining || 365) - days);
                            break;
                        case '‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®':
                            updates.internationalLeaveRemaining = Math.max(0, (userData.internationalLeaveRemaining || 730) - days);
                            break;
                        case '‡∏•‡∏≤‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏†‡∏≤‡∏û':
                            updates.rehabLeaveRemaining = Math.max(0, (userData.rehabLeaveRemaining || 180) - days);
                            break;
                        case '‡∏•‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™':
                            updates.followSpouseLeaveRemaining = Math.max(0, (userData.followSpouseLeaveRemaining || 365) - days);
                            break;
                        case '‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô':
                            updates.workOtherLeaveRemaining = Math.max(0, (userData.workOtherLeaveRemaining || 365) - days);
                            break;
                    }

                    if (Object.keys(updates).length > 0) {
                        await updateDoc(userRef, updates);
                    }
                }
            } catch (error) {
                console.error('Error updating user leave balance:', error);
            }
        }

        function showSuccess(type) {
            const successMsg = document.getElementById(`${type}SuccessMessage`);
            successMsg.classList.add('show');
            setTimeout(() => {
                successMsg.classList.remove('show');
            }, 5000);
        }

        function showError(type, message) {
            const errorMsg = document.getElementById(`${type}ErrorMessage`);
            const errorText = document.getElementById(`${type}ErrorText`);
            errorText.textContent = message;
            errorMsg.classList.add('show');
            setTimeout(() => {
                errorMsg.classList.remove('show');
            }, 5000);
        }

        // Initialize on load
        initialize();
    </script>
</body>
</html>
