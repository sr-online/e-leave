<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <meta name="theme-color" content="#2563eb">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ - ‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡∏Ñ‡∏£‡∏π</title>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Kanit', sans-serif;
            background: var(--bg);
            min-height: 100vh;
            display: flex;
            overflow-x: hidden;
            flex-direction: column;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: white;
            border-right: 1px solid var(--border);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 1001;
            left: 0;
            top: 0;
        }

        .sidebar-header {
            padding: 25px 20px;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .user-info-sidebar {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px 20px;
            background: var(--bg);
            margin: 15px;
            border-radius: 12px;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .nav-menu {
            padding: 15px 0;
        }

        .nav-item {
            padding: 14px 20px;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .nav-item:hover {
            background: var(--bg);
            border-left-color: var(--primary);
        }

        .nav-item.active {
            background: rgba(37, 99, 235, 0.1);
            border-left-color: var(--primary);
            color: var(--primary);
        }

        .nav-icon {
            font-size: 1.3rem;
            width: 28px;
            text-align: center;
        }

        .logout-btn {
            margin: 15px;
            padding: 12px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Kanit', sans-serif;
            font-weight: 600;
            width: calc(100% - 30px);
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            flex: 1;
            padding: 30px;
            padding-bottom: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .content-wrapper {
            flex: 1;
        }

        /* Mobile Header & Nav - Hidden on Desktop */
        .mobile-header {
            display: none;
        }

        .mobile-nav {
            display: none;
        }

        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: var(--text-light);
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-label {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-subvalue {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-top: 4px;
            font-weight: 500;
        }

        .stat-suffix {
            font-size: 1rem;
            color: var(--text-light);
            margin-left: 5px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            padding: 30px;
            margin-bottom: 25px;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 25px;
            color: var(--text);
        }

        /* Form Elements */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: var(--text);
            font-weight: 600;
            font-size: 0.95rem;
        }

        .required {
            color: var(--danger);
        }

        input, select, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: 'Kanit', sans-serif;
            font-size: 0.95rem;
            transition: all 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .date-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-family: 'Kanit', sans-serif;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: white;
            color: var(--text);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .form-actions {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }

        /* History Items */
        .history-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .history-item {
            padding: 20px;
            border-left: 4px solid var(--primary);
            background: var(--bg);
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .history-item:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .history-type {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-approved {
            background: #d1fae5;
            color: #065f46;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .history-details {
            color: var(--text-light);
            font-size: 0.9rem;
            line-height: 1.6;
        }

        /* Alert Box */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-info {
            background: #dbeafe;
            border-color: #2563eb;
            color: #1e40af;
        }

        .alert-warning {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }

        /* Edit Modal Styles */
        .edit-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .edit-modal.show {
            display: flex;
        }

        .edit-modal-content {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { 
                transform: translateY(30px);
                opacity: 0;
            }
            to { 
                transform: translateY(0);
                opacity: 1;
            }
        }

        .edit-modal-header {
            background: linear-gradient(135deg, var(--primary) 0%, #1e40af 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .edit-modal-header h2 {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .edit-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .edit-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .edit-modal-body {
            padding: 25px;
        }

        .edit-modal-footer {
            padding: 20px 25px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            body {
                padding: 0;
                display: block;
                padding-top: 60px; /* Space for fixed header */
            }

            /* Mobile Header */
            .mobile-header {
                display: flex !important;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 60px;
                background: white;
                border-bottom: 1px solid var(--border);
                z-index: 1002;
                padding: 0 15px;
                align-items: center;
                justify-content: space-between;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            }

            .mobile-header-left {
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .mobile-menu-btn {
                display: flex !important;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                width: 40px;
                height: 40px;
                background: transparent;
                border: none;
                cursor: pointer;
                padding: 8px;
                border-radius: 8px;
                transition: background 0.2s ease;
            }

            .mobile-menu-btn:hover {
                background: var(--bg);
            }

            .mobile-menu-btn span {
                display: block;
                width: 24px;
                height: 3px;
                background: var(--text);
                border-radius: 2px;
                transition: all 0.3s ease;
            }

            .mobile-menu-btn span:not(:last-child) {
                margin-bottom: 4px;
            }

            .mobile-menu-btn.active span:nth-child(1) {
                transform: translateY(7px) rotate(45deg);
            }

            .mobile-menu-btn.active span:nth-child(2) {
                opacity: 0;
            }

            .mobile-menu-btn.active span:nth-child(3) {
                transform: translateY(-7px) rotate(-45deg);
            }

            .mobile-logo {
                width: 40px;
                height: 40px;
                background: var(--primary);
                border-radius: 10px;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5rem;
            }

            .mobile-header-title {
                font-size: 1.1rem;
                font-weight: 600;
                color: var(--text);
            }

            .mobile-user-btn {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: var(--primary);
                color: white;
                display: flex;
                align-items: center;
                justify-content: center;
                font-weight: 600;
                font-size: 1rem;
                border: 2px solid white;
                box-shadow: 0 2px 8px rgba(37, 99, 235, 0.3);
            }

            /* Hide horizontal nav */
            .mobile-nav {
                display: none !important;
            }

            .sidebar {
                transform: translateX(-100%);
                width: 280px;
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .sidebar-overlay {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
            }

            .sidebar-overlay.show {
                display: block;
            }

            .main-content {
                margin-left: 0;
                padding: 15px;
                padding-top: 15px;
                padding-bottom: 0;
                width: 100%;
                min-height: 100vh;
            }

            .content-wrapper {
                padding-bottom: 20px;
            }

            .footer {
                padding: 15px;
                margin-top: 30px;
                font-size: 0.8rem;
            }

            .page-header {
                margin-bottom: 20px;
            }

            .page-title {
                font-size: 1.4rem;
            }

            .page-subtitle {
                font-size: 0.9rem;
            }

            .date-range {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .form-actions {
                flex-direction: column;
                gap: 10px;
            }

            .btn {
                width: 100%;
                padding: 14px 24px;
                font-size: 1rem;
            }

            .card {
                padding: 20px;
                margin-bottom: 20px;
            }

            .card-title {
                font-size: 1.1rem;
            }

            .stat-card {
                padding: 20px;
            }

            .stat-label {
                font-size: 0.85rem;
            }

            .stat-value {
                font-size: 2rem;
            }

            .history-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }

            .history-type {
                margin-bottom: 0;
            }

            .history-item {
                padding: 16px;
            }

            .form-group {
                margin-bottom: 18px;
            }

            label {
                font-size: 0.9rem;
                margin-bottom: 6px;
            }

            input, select, textarea {
                font-size: 16px !important; /* Prevent zoom on iOS */
                padding: 12px 14px;
            }

            .alert {
                padding: 12px 16px;
                font-size: 0.9rem;
            }

            .nav-item {
                padding: 16px 20px;
                font-size: 0.95rem;
            }

            .nav-icon {
                font-size: 1.4rem;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 12px;
            }

            .card {
                padding: 16px;
            }

            .page-title {
                font-size: 1.25rem;
            }

            .stat-value {
                font-size: 1.75rem;
            }
        }

        .mobile-menu-btn {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 999;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mobile-menu-btn:active {
            transform: scale(0.9);
        }

        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: flex !important;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-light);
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 15px;
        }

        /* Fiscal Year Notification Banner */
        .fiscal-year-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 9998;
            padding: 16px 24px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideDown 0.5s ease-out;
        }

        .fiscal-year-banner.critical {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .fiscal-year-banner.urgent {
            background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .banner-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            gap: 20px;
            color: white;
        }

        .banner-icon {
            font-size: 2.5rem;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.1);
            }
        }

        .banner-text {
            flex: 1;
        }

        .banner-text strong {
            display: block;
            font-size: 1.1rem;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .banner-text p {
            margin: 0;
            font-size: 0.95rem;
            opacity: 0.95;
        }

        .banner-close {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            font-weight: bold;
            transition: all 0.3s ease;
            line-height: 1;
        }

        .banner-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        body.has-banner .content-wrapper {
            padding-top: 76px;
        }

        body.has-banner .mobile-header {
            top: 76px;
        }

        @media (max-width: 768px) {
            .fiscal-year-banner {
                padding: 12px 16px;
            }
            
            .banner-content {
                gap: 12px;
            }
            
            .banner-icon {
                font-size: 2rem;
            }
            
            .banner-text strong {
                font-size: 1rem;
            }
            
            .banner-text p {
                font-size: 0.85rem;
            }
            
            body.has-banner .content-wrapper {
                padding-top: 90px;
            }
            
            body.has-banner .mobile-header {
                top: 76px;
            }
        }

        /* Contact Popup */
        .contact-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
            animation: fadeIn 0.3s ease;
        }

        .contact-popup.show {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .contact-popup-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 100%;
            padding: 0;
            position: relative;
            animation: slideUp 0.3s ease;
            overflow: hidden;
        }

        @keyframes slideUp {
            from {
                transform: translateY(30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .contact-popup-header {
            background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }

        .contact-popup-header-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .contact-popup-header h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .contact-popup-body {
            padding: 30px;
        }

        .contact-section {
            margin-bottom: 25px;
        }

        .contact-section:last-child {
            margin-bottom: 0;
        }

        .contact-section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .contact-section-title-icon {
            font-size: 1.3rem;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 12px;
            margin-bottom: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .contact-item:hover {
            background: #e0e7ff;
            transform: translateX(5px);
        }

        .contact-item:last-child {
            margin-bottom: 0;
        }

        .contact-item-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .contact-item-info {
            flex: 1;
        }

        .contact-item-name {
            font-weight: 600;
            color: var(--text);
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .contact-item-phone {
            color: #2563eb;
            font-size: 1.1rem;
            font-weight: 500;
            font-family: 'Courier New', monospace;
        }

        .contact-developer {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #fbbf24;
        }

        .contact-developer .contact-item-icon {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .contact-popup-footer {
            padding: 20px 30px;
            background: #f8fafc;
            text-align: center;
        }

        .contact-popup-close-btn {
            width: 100%;
            padding: 12px 24px;
            background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .contact-popup-close-btn:hover {
            background: linear-gradient(135deg, #4b5563 0%, #374151 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 480px) {
            .contact-popup-content {
                max-width: 100%;
                margin: 0 10px;
            }

            .contact-popup-header {
                padding: 20px;
            }

            .contact-popup-header-icon {
                font-size: 2.5rem;
            }

            .contact-popup-header h2 {
                font-size: 1.3rem;
            }

            .contact-popup-body {
                padding: 20px;
            }

            .contact-item {
                padding: 12px;
                gap: 12px;
            }

            .contact-item-icon {
                width: 40px;
                height: 40px;
                font-size: 1.3rem;
            }

            .contact-item-name {
                font-size: 0.95rem;
            }

            .contact-item-phone {
                font-size: 1rem;
            }
        }

    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script>
        // Configure Thai font for pdfMake
        if (typeof pdfMake !== 'undefined') {
            pdfMake.fonts = {
                THSarabunNew: {
                    normal: 'https://cdn.jsdelivr.net/npm/@fontsource/sarabun@4.5.0/files/sarabun-thai-400-normal.woff',
                    bold: 'https://cdn.jsdelivr.net/npm/@fontsource/sarabun@4.5.0/files/sarabun-thai-700-normal.woff',
                    italics: 'https://cdn.jsdelivr.net/npm/@fontsource/sarabun@4.5.0/files/sarabun-thai-400-normal.woff',
                    bolditalics: 'https://cdn.jsdelivr.net/npm/@fontsource/sarabun@4.5.0/files/sarabun-thai-700-normal.woff'
                },
                Roboto: {
                    normal: 'https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/fonts/Roboto/Roboto-Regular.ttf',
                    bold: 'https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/fonts/Roboto/Roboto-Medium.ttf',
                    italics: 'https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/fonts/Roboto/Roboto-Italic.ttf',
                    bolditalics: 'https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/fonts/Roboto/Roboto-MediumItalic.ttf'
                }
            };
        }
    </script>
</head>
<body>
    <!-- Fiscal Year Notification Banner -->
    <div id="fiscalYearBanner" class="fiscal-year-banner" style="display: none;">
        <div class="banner-content">
            <div class="banner-icon" id="bannerIcon">‚ö†Ô∏è</div>
            <div class="banner-text">
                <strong id="bannerTitle">‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</strong>
                <p id="bannerMessage">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</p>
            </div>
            <button class="banner-close" onclick="closeFiscalYearBanner()">√ó</button>
        </div>
    </div>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <div class="mobile-header-left">
            <button class="mobile-menu-btn" id="mobileMenuBtn" onclick="toggleSidebar(); toggleMenuIcon()">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <div class="mobile-logo">üìã</div>
            <div class="mobile-header-title">‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
        </div>
        <div class="mobile-user-btn" id="mobileUserBtn"></div>
    </div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-title">üìã‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
            <div style="font-size: 0.85rem; color: var(--text-light);">‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ö‡∏∏‡∏Ñ‡∏•‡∏≤‡∏Å‡∏£</div>
        </div>

        <div class="user-info-sidebar">
            <div class="user-avatar" id="userAvatar"></div>
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 600; font-size: 0.95rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" id="userName"></div>
                <div style="font-size: 0.85rem; color: var(--text-light); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" id="userPosition"></div>
            </div>
        </div>

        <div class="nav-menu">
            <div class="nav-item active" onclick="showSection('dashboard')">
                <span class="nav-icon">üè†</span>
                <span>‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</span>
            </div>
            <div class="nav-item" onclick="showSection('leave')">
                <span class="nav-icon">üìù</span>
                <span>‡∏¢‡∏∑‡πà‡∏ô‡πÉ‡∏ö‡∏•‡∏≤</span>
            </div>
            <div class="nav-item" onclick="showSection('history')">
                <span class="nav-icon">üìú</span>
                <span>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</span>
            </div>
            <div class="nav-item" onclick="showSection('official-trip')">
                <span class="nav-icon">üöó</span>
                <span>‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</span>
            </div>
            <div class="nav-item" onclick="showSection('late-arrival')">
                <span class="nav-icon">‚è∞</span>
                <span>‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</span>
            </div>
            <div class="nav-item" onclick="showContactPopup()">
                <span class="nav-icon">üìû</span>
                <span>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</span>
            </div>
        </div>

        <button class="logout-btn" onclick="logout()">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
    </div>

    <!-- Mobile Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>

    <!-- Main Content -->
    <div class="main-content">
        <div class="content-wrapper">
            <!-- Dashboard Section -->
            <div class="content-section active" id="dashboard-section">
            <div class="page-header">
                <h1 class="page-title">üìä ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h1>
                <p class="page-subtitle">‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ</p>
            </div>

            <div class="stats-grid" id="leaveStatsGrid">
                <div class="loading">
                    <div class="spinner"></div>
                    <div style="margin-top: 15px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                </div>
            </div>
        </div>

        <!-- Leave Section -->
        <div class="content-section" id="leave-section">
            <div class="page-header">
                <h1 class="page-title">üìù ‡∏¢‡∏∑‡πà‡∏ô‡πÉ‡∏ö‡∏•‡∏≤</h1>
                <p class="page-subtitle">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡πà‡∏ô‡πÉ‡∏ö‡∏•‡∏≤</p>
            </div>

            <div class="alert alert-warning" id="leaveAlert" style="display: none;"></div>

            <div class="card">
                <form id="leaveForm">
                    <div class="form-group">
                        <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤ <span class="required">*</span></label>
                        <select id="leaveType" required onchange="handleLeaveTypeChange()">
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</option>
                            <option value="‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</option>
                            <option value="‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£">‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£</option>
                            <option value="‡∏•‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏†‡∏£‡∏¥‡∏¢‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£">‡∏•‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏†‡∏£‡∏¥‡∏¢‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£</option>
                            <option value="‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß">‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</option>
                            <option value="‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô">‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô</option>
                            <option value="‡∏•‡∏≤‡∏≠‡∏∏‡∏õ‡∏™‡∏°‡∏ö‡∏ó">‡∏•‡∏≤‡∏≠‡∏∏‡∏õ‡∏™‡∏°‡∏ö‡∏ó</option>
                            <option value="‡∏•‡∏≤‡∏®‡∏∂‡∏Å‡∏©‡∏≤">‡∏•‡∏≤‡∏®‡∏∂‡∏Å‡∏©‡∏≤</option>
                            <option value="‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®">‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®</option>
                            <option value="‡∏•‡∏≤‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏†‡∏≤‡∏û">‡∏•‡∏≤‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏†‡∏≤‡∏û</option>
                            <option value="‡∏•‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™">‡∏•‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™</option>
                            <option value="‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô">‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô</option>
                        </select>
                    </div>

                    <!-- Sick Leave Continuation Notice -->
                    <div id="sickLeaveContinuationNotice" style="display: none; background: #fef3c7; border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: start; gap: 15px;">
                            <div style="font-size: 2rem;">üè•</div>
                            <div style="flex: 1;">
                                <h3 style="margin: 0 0 10px 0; color: #d97706; font-size: 1.1rem;">‡∏û‡∏ö‡πÉ‡∏ö‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</h3>
                                <div id="previousSickLeaveDetails" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                    <!-- ‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà -->
                                </div>
                                <p style="margin: 0; color: #92400e; font-weight: 500;">
                                    üí° ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ (‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏´‡∏°‡πà)
                                </p>
                            </div>
                        </div>
                    </div>

                    <div class="date-range">
                        <div class="form-group">
                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô <span class="required">*</span></label>
                            <input type="date" id="startDate" required>
                        </div>
                        <div class="form-group">
                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î <span class="required">*</span></label>
                            <input type="date" id="endDate" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤ <span class="required">*</span></label>
                        <textarea id="reason" placeholder="‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤..." required></textarea>
                    </div>

                    <div class="form-group">
                        <label>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡∏ó‡∏µ‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ <span class="required">*</span></label>
                        <input type="tel" id="contactPhone" placeholder="‡πÄ‡∏ä‡πà‡∏ô 081-234-5678" required pattern="[0-9-]+" maxlength="12">
                    </div>

                    <input type="hidden" id="continuationLeaveId" value="">

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="resetLeaveForm()">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        <button type="submit" class="btn btn-primary" id="normalSubmitBtn">‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤</button>
                        <button type="button" class="btn" id="continueSickLeaveBtn" onclick="continueSickLeave()" style="display: none; background: #f59e0b; color: white;">
                            ‚ûï ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡πà‡∏≠ (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Official Trip Section -->
        <div class="content-section" id="official-trip-section">
            <div class="page-header">
                <h1 class="page-title">üöó ‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</h1>
                <p class="page-subtitle">‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</p>
            </div>

            <div class="card">
                <form id="officialTripForm">
                    <div class="form-group">
                        <label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ <span class="required">*</span></label>
                        <select id="trainingType" required>
                            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</option>
                            <option value="‡∏≠‡∏ö‡∏£‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡∏ô‡πÄ‡∏≠‡∏á">‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡∏ô‡πÄ‡∏≠‡∏á</option>
                            <option value="‡∏≠‡∏ö‡∏£‡∏°‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö">‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö</option>
                            <option value="‡∏≠‡∏∑‡πà‡∏ô‡πÜ">‡∏≠‡∏∑‡πà‡∏ô‡πÜ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ <span class="required">*</span></label>
                        <input type="text" id="tripSubject" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°‡πÄ‡∏ä‡∏¥‡∏á‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£..." required>
                    </div>

                    <div class="date-range">
                        <div class="form-group">
                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô <span class="required">*</span></label>
                            <input type="date" id="tripStartDate" required>
                        </div>
                        <div class="form-group">
                            <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î <span class="required">*</span></label>
                            <input type="date" id="tripEndDate" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà <span class="required">*</span></label>
                        <input type="text" id="tripLocation" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏û‡∏°.‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°" required>
                    </div>

                    <div class="form-group">
                        <label>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå <span class="required">*</span></label>
                        <textarea id="tripPurpose" placeholder="‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£..." required></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="resetOfficialTripForm()">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        <button type="submit" class="btn btn-primary">‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</button>
                    </div>
                </form>
            </div>

            <!-- Trip Stats (moved after form) -->
            <div class="stats-grid" style="margin-top: 30px; margin-bottom: 30px;">
                <div class="stat-card">
                    <div class="stat-label">üöó ‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ (‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</div>
                    <div class="stat-value">
                        <span id="tripCount">0</span> <span class="stat-suffix">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                    </div>
                    <div class="stat-subvalue" id="tripDays">0 ‡∏ß‡∏±‡∏ô</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìÖ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                    <div class="stat-value">
                        <span id="tripCountMonth">0</span> <span class="stat-suffix">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                    </div>
                    <div class="stat-subvalue" id="tripDaysMonth">0 ‡∏ß‡∏±‡∏ô</div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</h2>
                <div id="officialTripHistory" class="history-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div style="margin-top: 15px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Late Arrival Section -->
        <div class="content-section" id="late-arrival-section">
            <div class="page-header">
                <h1 class="page-title">‚è∞ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</h1>
                <p class="page-subtitle">‡πÅ‡∏à‡πâ‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</p>
            </div>

            <div class="alert alert-info">
                <strong>üìå ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 08:00 ‡∏ô. ‡∏´‡∏≤‡∏Å‡πÄ‡∏•‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á
            </div>

            <div class="card">
                <form id="lateArrivalForm">
                    <div class="form-group">
                        <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà <span class="required">*</span></label>
                        <input type="date" id="lateDate" required readonly>
                    </div>

                    <div class="form-group">
                        <label>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô <span class="required">*</span></label>
                        <input type="time" id="arrivalTime" required>
                    </div>

                    <div class="form-group">
                        <label>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• <span class="required">*</span></label>
                        <textarea id="lateReason" placeholder="‡πÇ‡∏õ‡∏£‡∏î‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢..." required></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="resetLateArrivalForm()">‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
                        <button type="submit" class="btn btn-primary">‡∏™‡πà‡∏á‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢</button>
                    </div>
                </form>
            </div>

            <!-- Late Arrival Stats (moved after form) -->
            <div class="stats-grid" style="margin-top: 30px; margin-bottom: 20px;">
                <div class="stat-card">
                    <div class="stat-label">‚è∞ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢ (‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</div>
                    <div class="stat-value">
                        <span id="lateCount">0</span> <span class="stat-suffix">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">üìÖ ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                    <div class="stat-value">
                        <span id="lateCountMonth">0</span> <span class="stat-suffix">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 class="card-title">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢</h2>
                <div id="lateArrivalHistory" class="history-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div style="margin-top: 15px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div class="content-section" id="history-section">
            <div class="page-header">
                <h1 class="page-title">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</h1>
                <p class="page-subtitle">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏•‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
            </div>

            <div class="card">
                <div id="leaveHistory" class="history-list">
                    <div class="loading">
                        <div class="spinner"></div>
                        <div style="margin-top: 15px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
                    </div>
                </div>
            </div>
        </div>
        </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, where, orderBy, onSnapshot, getDocs, doc, getDoc, updateDoc, setDoc, limit } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDYxyr-KArgycFagZjgJLYGQppSM9Trz2U",
            authDomain: "e-leave-2a711.firebaseapp.com",
            projectId: "e-leave-2a711",
            storageBucket: "e-leave-2a711.firebasestorage.app",
            messagingSenderId: "600657791927",
            appId: "1:600657791927:web:da2848098c2844a0e47632",
            measurementId: "G-STGXNL3YLG"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Check authentication
        const currentUserData = sessionStorage.getItem('currentUser');
        if (!currentUserData) {
            window.location.href = 'index.html';
        }

        const currentUser = JSON.parse(currentUserData);
        const currentUserId = currentUser.id;
        const currentUserName = currentUser.name;

        // Update user display
        document.getElementById('userName').textContent = currentUser.name;
        document.getElementById('userPosition').textContent = currentUser.position || '‡∏Ñ‡∏£‡∏π';
        document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
        
        // Update mobile user button
        const mobileUserBtn = document.getElementById('mobileUserBtn');
        if (mobileUserBtn) {
            mobileUserBtn.textContent = currentUser.name.charAt(0);
        }

        // Navigation functions
        window.showSection = function(section) {
            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            
            document.getElementById(section + '-section').classList.add('active');
            if (event && event.target) {
                const navItem = event.target.closest('.nav-item');
                if (navItem) navItem.classList.add('active');
            }
            
            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                const menuBtn = document.getElementById('mobileMenuBtn');
                
                sidebar.classList.remove('show');
                overlay.classList.remove('show');
                if (menuBtn) menuBtn.classList.remove('active');
            }
        };

        window.toggleSidebar = function() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('show');
            overlay.classList.toggle('show');
        };

        window.toggleMenuIcon = function() {
            const menuBtn = document.getElementById('mobileMenuBtn');
            if (menuBtn) {
                menuBtn.classList.toggle('active');
            }
        };

        // Close sidebar when clicking overlay
        document.addEventListener('click', function(e) {
            if (e.target.id === 'sidebarOverlay') {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                const menuBtn = document.getElementById('mobileMenuBtn');
                
                sidebar.classList.remove('show');
                overlay.classList.remove('show');
                if (menuBtn) menuBtn.classList.remove('active');
            }
        });

        window.logout = function() {
            if (confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                sessionStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            }
        };

        // Set today's date for late arrival
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('lateDate').value = today;

        // Set minimum dates
        document.getElementById('tripStartDate').min = today;

        // Update trip end date minimum when start date changes
        document.getElementById('tripStartDate').addEventListener('change', function() {
            document.getElementById('tripEndDate').min = this.value;
        });

        // Handle leave type change for date validation
        window.handleLeaveTypeChange = function() {
            const leaveType = document.getElementById('leaveType').value;
            const startDateInput = document.getElementById('startDate');
            const alertDiv = document.getElementById('leaveAlert');
            
            if (leaveType === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢') {
                // Check for previous sick leave
                checkPreviousSickLeave();
                
                // ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢: can only select today, must be before 8:00 AM
                const now = new Date();
                const currentHour = now.getHours();
                
                startDateInput.min = today;
                startDateInput.max = today;
                startDateInput.value = today;
                
                if (currentHour >= 8) {
                    alertDiv.innerHTML = '<strong>‚ö†Ô∏è ‡∏Ñ‡∏≥‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô:</strong> ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 08:00 ‡∏ô. ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤, ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á';
                    alertDiv.style.display = 'block';
                } else {
                    alertDiv.style.display = 'none';
                }
            } else {
                // Hide continuation notice for non-sick leave
                document.getElementById('sickLeaveContinuationNotice').style.display = 'none';
                document.getElementById('continueSickLeaveBtn').style.display = 'none';
                document.getElementById('normalSubmitBtn').style.display = 'inline-block';
                document.getElementById('continuationLeaveId').value = '';
                unlockFormFields();
                
                if (leaveType === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß') {
                    // ‡∏•‡∏≤‡∏Å‡∏¥‡∏à: must be at least 3 days in advance
                    const minDate = new Date();
                    minDate.setDate(minDate.getDate() + 3);
                    const minDateStr = minDate.toISOString().split('T')[0];
                    
                    startDateInput.min = minDateStr;
                    startDateInput.max = '';
                    startDateInput.value = '';
                    
                    alertDiv.innerHTML = '<strong>üìå ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ß‡∏±‡∏ô';
                    alertDiv.style.display = 'block';
                } else {
                    startDateInput.min = today;
                    startDateInput.max = '';
                    alertDiv.style.display = 'none';
                }
            }
        };

        // Check for previous sick leave (simple version - no complex queries)
        function checkPreviousSickLeave() {
            // Validate currentUserId
            if (!currentUserId) {
                console.error('currentUserId not set');
                hideContinuationUI();
                return;
            }

            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const todayStr = today.toISOString().split('T')[0];

            // Simple query - only 2 where clauses
            const q = query(
                collection(db, 'leaves'),
                where('userId', '==', currentUserId),
                where('type', '==', '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢')
            );

            getDocs(q).then(snapshot => {
                let foundContinuation = false;
                let alreadyContinuedToday = false;
                
                snapshot.forEach(docSnapshot => {
                    const leave = docSnapshot.data();
                    
                    // Check if already continued to today
                    if (leave.endDate === todayStr && 
                        (leave.status === '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' || leave.status === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß')) {
                        alreadyContinuedToday = true;
                    }
                    
                    // Check if endDate is yesterday AND status is pending or approved
                    if (leave.endDate === yesterdayStr && 
                        (leave.status === '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' || leave.status === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß')) {
                        foundContinuation = true;
                        showContinuationUI(docSnapshot.id, leave, alreadyContinuedToday);
                    }
                });

                if (!foundContinuation) {
                    hideContinuationUI();
                }
            }).catch(error => {
                console.error('Error checking previous sick leave:', error);
                hideContinuationUI();
            });
        }

        // Show continuation UI
        function showContinuationUI(leaveId, leaveData, alreadyContinuedToday) {
            // Show notice
            document.getElementById('sickLeaveContinuationNotice').style.display = 'block';
            
            // Show or hide button based on whether already continued today
            if (alreadyContinuedToday) {
                document.getElementById('continueSickLeaveBtn').style.display = 'none';
                document.getElementById('normalSubmitBtn').style.display = 'none';
            } else {
                document.getElementById('continueSickLeaveBtn').style.display = 'inline-block';
                document.getElementById('normalSubmitBtn').style.display = 'none';
            }
            document.getElementById('continuationLeaveId').value = leaveId;

            // Show details
            const startDate = new Date(leaveData.startDate).toLocaleDateString('th-TH', {
                day: 'numeric', month: 'long', year: 'numeric'
            });
            const endDate = new Date(leaveData.endDate).toLocaleDateString('th-TH', {
                day: 'numeric', month: 'long', year: 'numeric'
            });

            let statusColor = leaveData.status === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' ? '#10b981' : '#f59e0b';
            let statusText = leaveData.status === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' ? '‚úì ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' : '‚è≥ ‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥';
            
            // Add message if already continued today
            let alreadyContinuedMessage = '';
            if (alreadyContinuedToday) {
                alreadyContinuedMessage = `
                    <div style="background: #fee2e2; padding: 10px; border-radius: 8px; margin-top: 10px; color: #dc2626;">
                        <strong>‚ö†Ô∏è ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</strong>
                        <div style="margin-top: 5px; font-size: 0.9rem;">
                            ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ
                        </div>
                    </div>
                `;
            }

            document.getElementById('previousSickLeaveDetails').innerHTML = `
                <div style="display: grid; gap: 8px;">
                    <div><strong>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</strong> ${leaveData.type}</div>
                    <div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${startDate} - ${endDate} (${leaveData.days} ‡∏ß‡∏±‡∏ô)</div>
                    <div><strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</strong> ${leaveData.reason}</div>
                    <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span style="color: ${statusColor}; font-weight: 600;">${statusText}</span></div>
                </div>
                ${alreadyContinuedMessage}
            `;

            // Lock and fill form
            document.getElementById('reason').value = leaveData.reason;
            document.getElementById('contactPhone').value = leaveData.contactPhone || '';
            lockFormFields();
        }

        // Hide continuation UI
        function hideContinuationUI() {
            document.getElementById('sickLeaveContinuationNotice').style.display = 'none';
            document.getElementById('continueSickLeaveBtn').style.display = 'none';
            document.getElementById('normalSubmitBtn').style.display = 'inline-block';
            document.getElementById('continuationLeaveId').value = '';
            unlockFormFields();
        }

        // Lock form fields
        function lockFormFields() {
            document.getElementById('startDate').readOnly = true;
            document.getElementById('endDate').readOnly = true;
            document.getElementById('reason').readOnly = true;
            document.getElementById('contactPhone').readOnly = true;
        }

        // Unlock form fields
        function unlockFormFields() {
            document.getElementById('startDate').readOnly = false;
            document.getElementById('endDate').readOnly = false;
            document.getElementById('reason').readOnly = false;
            document.getElementById('contactPhone').readOnly = false;
        }

        // Continue sick leave
        window.continueSickLeave = async function() {
            const leaveId = document.getElementById('continuationLeaveId').value;
            if (!leaveId) {
                alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏°');
                return;
            }

            try {
                const leaveRef = doc(db, 'leaves', leaveId);
                const leaveDoc = await getDoc(leaveRef);
                
                if (!leaveDoc.exists()) {
                    alert('‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏°');
                    return;
                }
                
                const oldLeaveData = leaveDoc.data();

                // Check if already continued today
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const todayStr = today.toISOString().split('T')[0];
                
                const oldEndDate = new Date(oldLeaveData.endDate);
                const oldEndDateStr = oldEndDate.toISOString().split('T')[0];
                
                // ‡∏ñ‡πâ‡∏≤ endDate ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß = ‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡∏•‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                if (oldEndDateStr === todayStr) {
                    alert('‚ùå ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ\n\n‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ');
                    return;
                }

                if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡πà‡∏≠ (‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)?\n\n‚Ä¢ ‡πÑ‡∏°‡πà‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÉ‡∏´‡∏°‡πà\n‚Ä¢ Admin ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡∏°‡πà')) {
                    return;
                }

                // Calculate new end date (old endDate + 1 day)
                oldEndDate.setDate(oldEndDate.getDate() + 1); // ‡πÄ‡∏û‡∏¥‡πà‡∏° 1 ‡∏ß‡∏±‡∏ô
                const newEndDateStr = oldEndDate.toISOString().split('T')[0];

                // Calculate new total days (working days only)
                const start = new Date(oldLeaveData.startDate);
                const end = new Date(newEndDateStr);
                let days = 0;
                for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                    const dayOfWeek = d.getDay();
                    if (dayOfWeek !== 0 && dayOfWeek !== 6) {
                        days++;
                    }
                }

                // Calculate previous approved days (if exists)
                const previousDays = oldLeaveData.days || 0;
                const continuationDays = days - previousDays; // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ

                // Update leave request
                await updateDoc(leaveRef, {
                    endDate: newEndDateStr,
                    days: days,
                    status: '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                    isContinuation: true,
                    previousDays: previousDays,  // ‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡πÄ‡∏î‡∏¥‡∏°
                    continuationDays: continuationDays,  // ‡πÄ‡∏Å‡πá‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°
                    continuedDate: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                });

                alert(`‚úÖ ‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!\n\n‚Ä¢ ‡∏•‡∏≤‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß: ${previousDays} ‡∏ß‡∏±‡∏ô\n‚Ä¢ ‡∏•‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°: ${continuationDays} ‡∏ß‡∏±‡∏ô\n‚Ä¢ ‡∏£‡∏ß‡∏°: ${days} ‡∏ß‡∏±‡∏ô\n\n‡∏£‡∏≠‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥`);
                
                // Reset and reload
                resetLeaveForm();
                loadLeaveHistory();
                
                // Reload stats
                loadLeaveStats();
                
            } catch (error) {
                console.error('Error continuing sick leave:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        };

        // Update end date minimum when start date changes
        document.getElementById('startDate').addEventListener('change', function() {
            document.getElementById('endDate').min = this.value;
        });

        // Leave form submission
        document.getElementById('leaveForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const leaveType = document.getElementById('leaveType').value;
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            // Validation for sick leave
            if (leaveType === '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢') {
                const now = new Date();
                const currentHour = now.getHours();
                const selectedDate = new Date(startDate);
                const todayDate = new Date(today);
                
                if (selectedDate.toDateString() !== todayDate.toDateString()) {
                    alert('‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                    return;
                }
                
                if (currentHour >= 8) {
                    alert('‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 08:00 ‡∏ô. ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏≤');
                    return;
                }
            }
            
            // Validation for personal leave
            if (leaveType === '‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß') {
                const selectedDate = new Date(startDate);
                const minDate = new Date();
                minDate.setDate(minDate.getDate() + 3);
                minDate.setHours(0, 0, 0, 0);
                selectedDate.setHours(0, 0, 0, 0);
                
                if (selectedDate < minDate) {
                    alert('‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ß‡∏±‡∏ô');
                    return;
                }
            }
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

            // Get user position
            const userDoc = await getDoc(doc(db, 'users', currentUserId));
            const userPosition = userDoc.exists() ? userDoc.data().position : '‡∏Ñ‡∏£‡∏π';

            const leaveData = {
                userId: currentUserId,
                userName: currentUserName,
                userPosition: userPosition,
                type: leaveType,
                startDate: startDate,
                endDate: endDate,
                reason: document.getElementById('reason').value,
                phone: document.getElementById('contactPhone').value,
                status: '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥',
                days: days,
                submittedDate: new Date().toISOString(),
                createdAt: new Date().toISOString()
            };

            try {
                await addDoc(collection(db, 'leaves'), leaveData);
                alert('‚úÖ ‡∏™‡πà‡∏á‡πÉ‡∏ö‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
                resetLeaveForm();
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        });

        // Official trip form submission
        document.getElementById('officialTripForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const startDate = document.getElementById('tripStartDate').value;
            const endDate = document.getElementById('tripEndDate').value;
            const start = new Date(startDate);
            const end = new Date(endDate);
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            const tripData = {
                userId: currentUserId,
                userName: currentUserName,
                trainingType: document.getElementById('trainingType').value,
                subject: document.getElementById('tripSubject').value,
                startDate: startDate,
                endDate: endDate,
                days: days,
                location: document.getElementById('tripLocation').value,
                purpose: document.getElementById('tripPurpose').value,
                status: '‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß',
                submittedDate: new Date().toISOString()
            };

            try {
                await addDoc(collection(db, 'official_trips'), tripData);
                alert('‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
                resetOfficialTripForm();
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        });

        // Late arrival form submission
        document.getElementById('lateArrivalForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const now = new Date();
            const currentHour = now.getHours();
            
            if (currentHour >= 8) {
                alert('‚ö†Ô∏è ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 08:00 ‡∏ô. ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô\n\n‡∏´‡∏≤‡∏Å‡πÄ‡∏•‡∏¢‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á');
                return;
            }
            
            const lateData = {
                userId: currentUserId,
                userName: currentUserName,
                date: document.getElementById('lateDate').value,
                arrivalTime: document.getElementById('arrivalTime').value,
                reason: document.getElementById('lateReason').value,
                status: '‡πÅ‡∏à‡πâ‡∏á‡πÅ‡∏•‡πâ‡∏ß',
                submittedDate: new Date().toISOString()
            };

            try {
                await addDoc(collection(db, 'late_arrivals'), lateData);
                alert('‚úÖ ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!');
                resetLateArrivalForm();
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        });

        // Reset functions
        window.resetLeaveForm = function() {
            document.getElementById('leaveForm').reset();
            document.getElementById('leaveAlert').style.display = 'none';
        };

        window.resetOfficialTripForm = function() {
            document.getElementById('officialTripForm').reset();
        };

        window.resetLateArrivalForm = function() {
            document.getElementById('lateArrivalForm').reset();
            document.getElementById('lateDate').value = today;
        };

        // Load statistics
        async function loadLeaveStats() {
            const statsGrid = document.getElementById('leaveStatsGrid');
            
            try {
                // Load leave stats
                const leavesQuery = query(
                    collection(db, 'leaves'),
                    where('userId', '==', currentUserId),
                    where('status', '==', '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß')
                );
                
                const leavesSnapshot = await getDocs(leavesQuery);
                
                const leaveCounts = {};
                const leaveDays = {};
                const leaveIcons = {
                    '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢': 'üè•',
                    '‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£': 'üë∂',
                    '‡∏•‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏†‡∏£‡∏¥‡∏¢‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£': 'ü§±',
                    '‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß': 'üìù',
                    '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô': 'üèñÔ∏è',
                    '‡∏•‡∏≤‡∏≠‡∏∏‡∏õ‡∏™‡∏°‡∏ö‡∏ó': 'üôè',
                    '‡∏•‡∏≤‡∏®‡∏∂‡∏Å‡∏©‡∏≤': 'üìö',
                    '‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®': 'üåè',
                    '‡∏•‡∏≤‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏†‡∏≤‡∏û': 'üí™',
                    '‡∏•‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™': '‚úàÔ∏è',
                    '‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô': 'üèõÔ∏è'
                };
                
                leavesSnapshot.forEach(doc => {
                    const leave = doc.data();
                    if (!leaveCounts[leave.type]) {
                        leaveCounts[leave.type] = 0;
                        leaveDays[leave.type] = 0;
                    }
                    leaveCounts[leave.type]++;
                    leaveDays[leave.type] += leave.days || 0;
                });
                
                // Load trip stats
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth();
                
                const tripQuery = query(
                    collection(db, 'official_trips'),
                    where('userId', '==', currentUserId)
                );
                const tripSnapshot = await getDocs(tripQuery);
                
                let tripCount = 0;
                let tripDays = 0;
                let tripCountMonth = 0;
                
                tripSnapshot.forEach(doc => {
                    const trip = doc.data();
                    const tripDate = trip.startDate ? new Date(trip.startDate) : (trip.date ? new Date(trip.date) : null);
                    
                    if (tripDate) {
                        tripCount++;
                        const days = trip.days || 1;
                        tripDays += days;
                        
                        if (tripDate.getFullYear() === currentYear && tripDate.getMonth() === currentMonth) {
                            tripCountMonth++;
                        }
                    }
                });
                
                // Load late arrival stats
                const lateQuery = query(
                    collection(db, 'late_arrivals'),
                    where('userId', '==', currentUserId)
                );
                const lateSnapshot = await getDocs(lateQuery);
                
                let lateCount = 0;
                let lateCountMonth = 0;
                
                lateSnapshot.forEach(doc => {
                    const late = doc.data();
                    const lateDate = new Date(late.date);
                    
                    if (lateDate.getFullYear() === currentYear) {
                        lateCount++;
                        
                        if (lateDate.getMonth() === currentMonth) {
                            lateCountMonth++;
                        }
                    }
                });
                
                const usedLeaveTypes = Object.entries(leaveCounts);
                
                let html = '';
                
                // Leave stats
                if (usedLeaveTypes.length > 0) {
                    html += usedLeaveTypes.map(([type, count]) => `
                        <div class="stat-card">
                            <div class="stat-label">
                                <span style="font-size: 1.5rem;">${leaveIcons[type] || 'üìã'}</span>
                                <span>${type}</span>
                            </div>
                            <div class="stat-value">
                                ${count}
                                <span class="stat-suffix">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                            </div>
                            <div class="stat-subvalue">${leaveDays[type]} ‡∏ß‡∏±‡∏ô</div>
                        </div>
                    `).join('');
                }
                
                // Trip stats
                if (tripCount > 0) {
                    html += `
                        <div class="stat-card">
                            <div class="stat-label">
                                <span style="font-size: 1.5rem;">üöó</span>
                                <span>‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</span>
                            </div>
                            <div class="stat-value">
                                ${tripCount}
                                <span class="stat-suffix">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                            </div>
                            <div class="stat-subvalue">${tripDays} ‡∏ß‡∏±‡∏ô</div>
                        </div>
                    `;
                }
                
                // Late arrival stats
                if (lateCount > 0) {
                    html += `
                        <div class="stat-card">
                            <div class="stat-label">
                                <span style="font-size: 1.5rem;">‚è∞</span>
                                <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢ (‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</span>
                            </div>
                            <div class="stat-value">
                                ${lateCount}
                                <span class="stat-suffix">‡∏Ñ‡∏£‡∏±‡πâ‡∏á</span>
                            </div>
                            <div class="stat-subvalue">${lateCountMonth} ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
                        </div>
                    `;
                }
                
                if (html === '') {
                    statsGrid.innerHTML = `
                        <div class="empty-state" style="grid-column: 1/-1;">
                            <div class="empty-icon">üìä</div>
                            <div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</div>
                        </div>
                    `;
                } else {
                    statsGrid.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                statsGrid.innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <div class="empty-icon">‚ùå</div>
                        <div>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
                    </div>
                `;
            }
        }

        // Load official trip stats
        async function loadTripStats() {
            try {
                const now = new Date();
                const currentFY = getFiscalYear(now);
                
                // Fiscal year range: 1 Oct (previous year) - 30 Sep (current fiscal year)
                const fyStart = new Date(currentFY - 1, 9, 1);
                const fyEnd = new Date(currentFY, 8, 30, 23, 59, 59, 999);
                
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth();
                
                const q = query(
                    collection(db, 'official_trips'),
                    where('userId', '==', currentUserId)
                );

                const snapshot = await getDocs(q);
                
                let fyCount = 0;
                let fyDays = 0;
                let monthCount = 0;
                let monthDays = 0;

                snapshot.forEach((doc) => {
                    const trip = doc.data();
                    const startDate = new Date(trip.startDate || trip.date);
                    const endDate = new Date(trip.endDate || trip.date);
                    
                    // Calculate days
                    const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                    
                    // Fiscal year stats
                    if (startDate >= fyStart && startDate <= fyEnd) {
                        fyCount++;
                        fyDays += days;
                    }
                    
                    // Check if in current month
                    if (startDate.getFullYear() === currentYear && startDate.getMonth() === currentMonth) {
                        monthCount++;
                        monthDays += days;
                    }
                });

                document.getElementById('tripCount').textContent = fyCount;
                document.getElementById('tripDays').textContent = `${fyDays} ‡∏ß‡∏±‡∏ô`;
                document.getElementById('tripCountMonth').textContent = monthCount;
                document.getElementById('tripDaysMonth').textContent = `${monthDays} ‡∏ß‡∏±‡∏ô`;
            } catch (error) {
                console.error('Error loading trip stats:', error);
            }
        }

        // Load late arrival stats
        async function loadLateStats() {
            try {
                const now = new Date();
                const currentFY = getFiscalYear(now);
                
                // Fiscal year range: 1 Oct (previous year) - 30 Sep (current fiscal year)
                const fyStart = new Date(currentFY - 1, 9, 1);
                const fyEnd = new Date(currentFY, 8, 30, 23, 59, 59, 999);
                
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth();
                
                const q = query(
                    collection(db, 'late_arrivals'),
                    where('userId', '==', currentUserId)
                );

                const snapshot = await getDocs(q);
                
                let fyCount = 0;
                let monthCount = 0;

                snapshot.forEach((doc) => {
                    const late = doc.data();
                    const lateDate = new Date(late.date);
                    
                    // Count for fiscal year
                    if (lateDate >= fyStart && lateDate <= fyEnd) {
                        fyCount++;
                    }
                    
                    // Count for current month
                    if (lateDate.getFullYear() === currentYear && lateDate.getMonth() === currentMonth) {
                        monthCount++;
                    }
                });

                document.getElementById('lateCount').textContent = fyCount;
                document.getElementById('lateCountMonth').textContent = monthCount;
            } catch (error) {
                console.error('Error loading late stats:', error);
            }
        }

        // Load leave history
        function loadLeaveHistory() {
            const historyDiv = document.getElementById('leaveHistory');
            
            const q = query(
                collection(db, 'leaves'),
                where('userId', '==', currentUserId)
            );

            onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    historyDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div><div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤</div></div>';
                    return;
                }

                const leaves = [];
                querySnapshot.forEach((doc) => {
                    leaves.push({ id: doc.id, ...doc.data() });
                });

                leaves.sort((a, b) => {
                    const dateA = a.submittedDate ? new Date(a.submittedDate) : new Date(0);
                    const dateB = b.submittedDate ? new Date(b.submittedDate) : new Date(0);
                    return dateB - dateA;
                });

                historyDiv.innerHTML = leaves.map(leave => {
                    const statusClass = leave.status === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß' ? 'status-approved' : 
                                      leave.status === '‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥' ? 'status-rejected' : 'status-pending';
                    
                    const startDate = new Date(leave.startDate).toLocaleDateString('th-TH', { 
                        day: 'numeric', month: 'short', year: 'numeric' 
                    });
                    const endDate = new Date(leave.endDate).toLocaleDateString('th-TH', { 
                        day: 'numeric', month: 'short', year: 'numeric' 
                    });

                    const style = getLeaveTypeStyle(leave.type);
                    
                    // Show continuation info if applicable
                    let continuationInfo = '';
                    if (leave.isContinuation && leave.previousDays && leave.continuationDays) {
                        continuationInfo = `
                            <div style="background: #fef3c7; padding: 10px; border-radius: 8px; margin-top: 8px;">
                                <strong>üìä ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏≤:</strong>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 5px;">
                                    <div>‚Ä¢ ‡∏•‡∏≤‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß: <strong>${leave.previousDays}</strong> ‡∏ß‡∏±‡∏ô (1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</div>
                                    <div>‚Ä¢ ‡∏•‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ: <strong>${leave.continuationDays}</strong> ‡∏ß‡∏±‡∏ô (0 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</div>
                                </div>
                                <div style="margin-top: 5px; color: #d97706;">
                                    üí° ‡∏•‡∏≤‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á - ‡∏£‡∏ß‡∏° ${leave.days} ‡∏ß‡∏±‡∏ô ‡∏ô‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 1 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                                </div>
                            </div>
                        `;
                    }
                    
                    // Add action buttons based on status
                    let actionButtons = '';
                    if (leave.status === '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') {
                        actionButtons = `
                            <div style="display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap;">
                                <button class="btn" style="background: #2563eb; font-size: 0.9rem; flex: 1; min-width: 120px;" onclick="openEditLeaveModal('${leave.id}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                <button class="btn" style="background: #ef4444; font-size: 0.9rem; flex: 1; min-width: 120px;" onclick="cancelLeave('${leave.id}')">üóëÔ∏è ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                            </div>
                        `;
                    } else if (leave.status === '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß') {
                        actionButtons = `<button class="btn" style="background: #10b981; margin-top: 10px; font-size: 0.9rem;" onclick="generateMyLeavePDF('${leave.id}')">üìÑ ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ PDF</button>`;
                    }

                    return `
                        <div class="history-item">
                            <div class="history-header">
                                <div class="history-type" style="background: ${style.bg}; color: ${style.color};">
                                    <span style="font-size: 1.2rem;">${style.icon}</span>
                                    <span>${leave.type}</span>
                                </div>
                                <span class="status-badge ${statusClass}">${leave.status}</span>
                            </div>
                            <div class="history-details">
                                <div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${startDate} - ${endDate} (${leave.days} ‡∏ß‡∏±‡∏ô)</div>
                                <div><strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</strong> ${leave.reason}</div>
                                ${continuationInfo}
                                ${leave.adminNote ? `<div style="color: var(--danger); margin-top: 8px;"><strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${leave.adminNote}</div>` : ''}
                                ${actionButtons}
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }

        // Load official trip history
        function loadOfficialTripHistory() {
            const historyDiv = document.getElementById('officialTripHistory');
            
            const q = query(
                collection(db, 'official_trips'),
                where('userId', '==', currentUserId)
            );

            onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    historyDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div><div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</div></div>';
                    return;
                }

                const trips = [];
                querySnapshot.forEach((doc) => {
                    trips.push({ id: doc.id, ...doc.data() });
                });

                trips.sort((a, b) => new Date(b.startDate || b.date) - new Date(a.startDate || a.date));

                historyDiv.innerHTML = trips.map(trip => {
                    // Support both old and new format
                    const startDate = trip.startDate ? new Date(trip.startDate).toLocaleDateString('th-TH', { 
                        day: 'numeric', month: 'long', year: 'numeric' 
                    }) : new Date(trip.date).toLocaleDateString('th-TH', { 
                        day: 'numeric', month: 'long', year: 'numeric' 
                    });
                    
                    const endDate = trip.endDate ? new Date(trip.endDate).toLocaleDateString('th-TH', { 
                        day: 'numeric', month: 'long', year: 'numeric' 
                    }) : startDate;
                    
                    const dateDisplay = trip.startDate && trip.endDate && trip.startDate !== trip.endDate 
                        ? `${startDate} - ${endDate} (${trip.days} ‡∏ß‡∏±‡∏ô)`
                        : startDate;

                    return `
                        <div class="history-item">
                            <div class="history-header">
                                <div class="history-type" style="background: #dbeafe; color: #1e40af;">
                                    <span style="font-size: 1.2rem;">üöó</span>
                                    <span>‡πÑ‡∏õ‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£</span>
                                </div>
                                <span class="status-badge status-approved">${trip.status}</span>
                            </div>
                            <div class="history-details">
                                ${trip.subject ? `<div><strong>‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á:</strong> ${trip.subject}</div>` : ''}
                                <div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${dateDisplay}</div>
                                <div><strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</strong> ${trip.location}</div>
                                <div><strong>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå:</strong> ${trip.purpose}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }

        // Load late arrival history
        function loadLateArrivalHistory() {
            const historyDiv = document.getElementById('lateArrivalHistory');
            
            const q = query(
                collection(db, 'late_arrivals'),
                where('userId', '==', currentUserId)
            );

            onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    historyDiv.innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div><div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢</div></div>';
                    return;
                }

                const lates = [];
                querySnapshot.forEach((doc) => {
                    lates.push({ id: doc.id, ...doc.data() });
                });

                lates.sort((a, b) => new Date(b.date) - new Date(a.date));

                historyDiv.innerHTML = lates.map(late => {
                    const date = new Date(late.date).toLocaleDateString('th-TH', { 
                        day: 'numeric', month: 'long', year: 'numeric' 
                    });

                    return `
                        <div class="history-item">
                            <div class="history-header">
                                <div class="history-type" style="background: #fef3c7; color: #92400e;">
                                    <span style="font-size: 1.2rem;">‚è∞</span>
                                    <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏≤‡∏¢</span>
                                </div>
                                <span class="status-badge status-approved">${late.status}</span>
                            </div>
                            <div class="history-details">
                                <div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${date}</div>
                                <div><strong>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏á‡∏≤‡∏ô:</strong> ${late.arrivalTime} ‡∏ô.</div>
                                <div><strong>‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•:</strong> ${late.reason}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }

        function getLeaveTypeStyle(type) {
            const styles = {
                '‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢': { icon: 'üè•', color: '#ef4444', bg: '#fee2e2' },
                '‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£': { icon: 'üë∂', color: '#ec4899', bg: '#fce7f3' },
                '‡∏•‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏†‡∏£‡∏¥‡∏¢‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£': { icon: 'ü§±', color: '#f59e0b', bg: '#fef3c7' },
                '‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß': { icon: 'üìù', color: '#3b82f6', bg: '#dbeafe' },
                '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô': { icon: 'üèñÔ∏è', color: '#10b981', bg: '#d1fae5' },
                '‡∏•‡∏≤‡∏≠‡∏∏‡∏õ‡∏™‡∏°‡∏ö‡∏ó': { icon: 'üôè', color: '#06b6d4', bg: '#cffafe' },
                '‡∏•‡∏≤‡∏®‡∏∂‡∏Å‡∏©‡∏≤': { icon: 'üìö', color: '#8b5cf6', bg: '#ede9fe' },
                '‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®': { icon: 'üåè', color: '#14b8a6', bg: '#ccfbf1' },
                '‡∏•‡∏≤‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏†‡∏≤‡∏û': { icon: 'üí™', color: '#f97316', bg: '#ffedd5' },
                '‡∏•‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™': { icon: '‚úàÔ∏è', color: '#6366f1', bg: '#e0e7ff' },
                '‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô': { icon: 'üèõÔ∏è', color: '#64748b', bg: '#f1f5f9' }
            };
            return styles[type] || { icon: 'üìã', color: '#64748b', bg: '#f1f5f9' };
        }

        // ============================================
        // FISCAL YEAR FUNCTIONS
        // ============================================

        // Get Thai fiscal year (1 Oct - 30 Sep)
        function getFiscalYear(date = new Date()) {
            const year = date.getFullYear();
            const month = date.getMonth(); // 0-11
            
            // If month is 0-8 (Jan-Sep), fiscal year is current year
            // If month is 9-11 (Oct-Dec), fiscal year is next year
            return month >= 9 ? year + 1 : year;
        }

        // Get days until fiscal year end
        function getDaysUntilFiscalYearEnd() {
            const today = new Date();
            const currentFY = getFiscalYear(today);
            const fyEnd = new Date(currentFY, 8, 30, 23, 59, 59, 999); // Sep 30
            
            const diffTime = fyEnd - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return diffDays > 0 ? diffDays : 0;
        }

        // Show fiscal year notification banner
        function showFiscalYearNotification() {
            const daysLeft = getDaysUntilFiscalYearEnd();
            const banner = document.getElementById('fiscalYearBanner');
            const bannerIcon = document.getElementById('bannerIcon');
            const bannerTitle = document.getElementById('bannerTitle');
            const bannerMessage = document.getElementById('bannerMessage');
            
            // Check if banner was dismissed today
            const dismissedDate = localStorage.getItem('fyBannerDismissed');
            const today = new Date().toDateString();
            
            if (dismissedDate === today) {
                return; // Don't show if dismissed today
            }
            
            // Show banner based on days left
            if (daysLeft > 0 && daysLeft <= 30) {
                const currentFY = getFiscalYear();
                
                // Determine severity and message
                if (daysLeft === 1) {
                    banner.className = 'fiscal-year-banner critical';
                    bannerIcon.textContent = 'üö®';
                    bannerTitle.textContent = '‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì - ‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ!';
                    bannerMessage.textContent = `‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ (1 ‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏° ${currentFY}) ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå`;
                } else if (daysLeft <= 7) {
                    banner.className = 'fiscal-year-banner critical';
                    bannerIcon.textContent = '‚ö†Ô∏è';
                    bannerTitle.textContent = '‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì - ‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ!';
                    bannerMessage.textContent = `‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏° ${currentFY} (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ${daysLeft} ‡∏ß‡∏±‡∏ô) ‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô`;
                } else if (daysLeft <= 14) {
                    banner.className = 'fiscal-year-banner urgent';
                    bannerIcon.textContent = 'üìÖ';
                    bannerTitle.textContent = '‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì';
                    bannerMessage.textContent = `‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏° ${currentFY} (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ${daysLeft} ‡∏ß‡∏±‡∏ô)`;
                } else {
                    banner.className = 'fiscal-year-banner';
                    bannerIcon.textContent = 'üì¢';
                    bannerTitle.textContent = '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÉ‡∏´‡∏°‡πà';
                    bannerMessage.textContent = `‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1 ‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏° ${currentFY} (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ${daysLeft} ‡∏ß‡∏±‡∏ô)`;
                }
                
                banner.style.display = 'block';
                document.body.classList.add('has-banner');
            } else if (daysLeft === 0) {
                // Today is Oct 1 - show different message
                const currentFY = getFiscalYear();
                banner.className = 'fiscal-year-banner critical';
                bannerIcon.textContent = 'üéâ';
                bannerTitle.textContent = '‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì!';
                bannerMessage.textContent = `‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${currentFY} ‡∏ß‡∏±‡∏ô‡∏•‡∏≤‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô`;
                banner.style.display = 'block';
                document.body.classList.add('has-banner');
            }
        }

        // Close fiscal year banner
        window.closeFiscalYearBanner = function() {
            const banner = document.getElementById('fiscalYearBanner');
            banner.style.display = 'none';
            document.body.classList.remove('has-banner');
            
            // Save dismissal date
            localStorage.setItem('fyBannerDismissed', new Date().toDateString());
        };

        // ============================================
        // PDF GENERATION FUNCTIONS
        // ============================================

        // Thai date formatting
        function formatThaiDate(dateStr) {
            const date = new Date(dateStr);
            const thaiYear = date.getFullYear() + 543;
            const months = ['', '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                           '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];
            return `${date.getDate()} ${months[date.getMonth() + 1]} ${thaiYear}`;
        }

        // Generate approved leave PDF for teacher - Simple Version

        // Generate approved leave PDF for teacher
        // Generate approved leave PDF for teacher - FIXED STATISTICS
        window.generateMyLeavePDF = async function(leaveId) {
            try {
                const leaveDoc = await getDoc(doc(db, 'leaves', leaveId));
                if (!leaveDoc.exists()) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏•‡∏≤');
                    return;
                }

                const leave = leaveDoc.data();
                
                if (leave.status !== '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß') {
                    alert('‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                    return;
                }

                const approvedDate = leave.approvedDate || leave.submittedDate;
                
                // Get ALL leave types statistics - OPTIMIZED with limit
                const allTypes = ['‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢', '‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£', '‡∏•‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏†‡∏£‡∏¥‡∏¢‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£', '‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß', '‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô', '‡∏•‡∏≤‡∏≠‡∏∏‡∏õ‡∏™‡∏°‡∏ö‡∏ó', '‡∏•‡∏≤‡∏®‡∏∂‡∏Å‡∏©‡∏≤', '‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®', '‡∏•‡∏≤‡∏ü‡∏∑‡πâ‡∏ô‡∏ü‡∏π‡∏™‡∏°‡∏£‡∏£‡∏ñ‡∏†‡∏≤‡∏û', '‡∏•‡∏≤‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏°‡∏Ñ‡∏π‡πà‡∏™‡∏°‡∏£‡∏™', '‡∏•‡∏≤‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡∏≠‡∏∑‡πà‡∏ô'];
                
                const stats = {};
                allTypes.forEach(t => stats[t] = {times: 0, days: 0});
                
                try {
                    const q = query(
                        collection(db, 'leaves'), 
                        where('userId', '==', currentUserId), 
                        where('status', '==', '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß'),
                        limit(100)
                    );
                    const snap = await getDocs(q);
                    
                    console.log(`[Teacher] Found ${snap.size} approved leaves`);
                    
                    snap.forEach(d => {
                        const data = d.data();
                        console.log(`[Teacher] Leave: ${data.type}, days: ${data.days}, id: ${d.id}`);
                        
                        if (stats[data.type]) {
                            stats[data.type].times++;
                            stats[data.type].days += (data.days || 0);
                        }
                    });
                    
                    console.log('[Teacher] Final stats:', stats);
                    
                } catch (e) {
                    console.error('[Teacher] Stats error:', e);
                }
                
                // Build table
                const tableBody = [[
                    {text: '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤', bold: true, fontSize: 10},
                    {text: '‡∏•‡∏≤‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß', bold: true, fontSize: 10},
                    {text: '‡∏•‡∏≤‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏µ‡πâ', bold: true, fontSize: 10},
                    {text: '‡∏£‡∏ß‡∏°', bold: true, fontSize: 10}
                ]];
                
                allTypes.forEach(type => {
                    const s = stats[type];
                    const isCurrent = (type === leave.type);
                    
                    // Calculate correctly
                    const timesBefore = isCurrent ? Math.max(0, s.times - 1) : s.times;
                    const daysBefore = isCurrent ? Math.max(0, s.days - leave.days) : s.days;
                    const totalTimes = s.times;
                    const totalDays = s.days;
                    
                    console.log(`[Teacher] ${type}: before=${timesBefore}/${daysBefore}, current=${isCurrent ? '1/' + leave.days : '-'}, total=${totalTimes}/${totalDays}`);
                    
                    // Show only types with data
                    if (s.times > 0) {
                        tableBody.push([
                            {text: type, fontSize: 9},
                            {text: `${timesBefore}/${daysBefore}`, fontSize: 9},
                            {text: isCurrent ? `1/${leave.days}` : '-', fontSize: 9},
                            {text: `${totalTimes}/${totalDays}`, fontSize: 9}
                        ]);
                    }
                });
                
                const docDefinition = {
                    pageSize: 'A4',
                    pageMargins: [40, 40, 40, 40],
                    defaultStyle: {font: 'THSarabunNew', fontSize: 12},
                    content: [
                        {text: '‡πÉ‡∏ö‡∏•‡∏≤', alignment: 'center', fontSize: 16, bold: true, margin: [0,0,0,15]},
                        {text: '‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏´‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏£‡∏±‡∏á‡∏™‡∏§‡∏©‡∏î‡∏¥‡πå', alignment: 'right', fontSize: 12, margin: [0,0,0,3]},
                        {text: `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà  ${formatThaiDate(leave.submittedDate)}`, alignment: 'right', fontSize: 12, margin: [0,0,0,15]},
                        {text: `‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á   ${leave.type}`, fontSize: 12, margin: [0,0,0,8]},
                        {text: '‡πÄ‡∏£‡∏µ‡∏¢‡∏ô  ‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏´‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏£‡∏±‡∏á‡∏™‡∏§‡∏©‡∏î‡∏¥‡πå', fontSize: 12, margin: [0,0,0,10]},
                        {text: [{text: '       ‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤ ', fontSize: 12}, {text: leave.userName, bold: true, fontSize: 12}, {text: ' ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ', fontSize: 12}, {text: leave.userPosition || '‡∏Ñ‡∏£‡∏π', bold: true, fontSize: 12}, {text: ' ‡∏™‡∏±‡∏á‡∏Å‡∏±‡∏î‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ñ‡∏ì‡∏∞‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô', fontSize: 12}], margin: [0,0,0,8]},
                        {text: [{text: '‡∏Ç‡∏≠‡∏•‡∏≤ ', fontSize: 12}, {text: leave.type, bold: true, fontSize: 12}, {text: ' ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å ', fontSize: 12}, {text: leave.reason, bold: true, fontSize: 12}], margin: [0,0,0,8]},
                        {text: [{text: '‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ', fontSize: 12}, {text: formatThaiDate(leave.startDate), bold: true, fontSize: 12}, {text: ' ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ', fontSize: 12}, {text: formatThaiDate(leave.endDate), bold: true, fontSize: 12}, {text: ' ‡∏£‡∏ß‡∏° ', fontSize: 12}, {text: `${leave.days}`, bold: true, fontSize: 12}, {text: ' ‡∏ß‡∏±‡∏ô', fontSize: 12}], margin: [0,0,0,8]},
                        {text: `‡πÉ‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏•‡∏≤‡∏à‡∏∞‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≤‡∏û‡πÄ‡∏à‡πâ‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà ${leave.phone || '-'}`, fontSize: 12, margin: [0,0,0,15]},
                        {text: '‡∏Ç‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ô‡∏±‡∏ö‡∏ñ‡∏∑‡∏≠', alignment: 'center', fontSize: 12, margin: [0,0,0,30]},
                        {text: `(‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠) ${leave.userName}`, alignment: 'center', fontSize: 12, margin: [0,0,0,3]},
                        {text: `(${leave.userName})`, alignment: 'center', fontSize: 12, margin: [0,0,0,15]},
                        {text: '‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡πÉ‡∏ô‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏ô‡∏µ‡πâ', bold: true, fontSize: 11, margin: [0,0,0,5]},
                        {table: {headerRows: 1, widths: ['*', 60, 60, 60], body: tableBody}, layout: {hLineWidth: () => 0.5, vLineWidth: () => 0.5}, margin: [0,0,0,15]},
                        {text: '(‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠) ‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡πÄ‡∏≠‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏£‡∏µ ‡πÄ‡∏≠‡∏Å‡∏û‡∏±‡∏ô‡∏ò‡πå  ‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', alignment: 'center', fontSize: 12, margin: [0,0,0,3]},
                        {text: '(‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß‡πÄ‡∏≠‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏£‡∏µ ‡πÄ‡∏≠‡∏Å‡∏û‡∏±‡∏ô‡∏ò‡πå)', alignment: 'center', fontSize: 12, margin: [0,0,0,3]},
                        {text: '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏á‡∏≤‡∏ô‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•', alignment: 'center', fontSize: 12, margin: [0,0,0,3]},
                        {text: `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(approvedDate)}`, alignment: 'center', fontSize: 12, margin: [0,0,0,15]},
                        {text: '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏≤', fontSize: 12, margin: [0,0,0,3]},
                        {text: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥', bold: true, fontSize: 12, alignment: 'center', margin: [0,0,0,15]},
                        {text: '(‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠) ‡∏ô‡∏≤‡∏¢‡∏≠‡∏†‡∏¥‡∏£‡∏±‡∏Å‡∏Ç‡∏†‡∏π‡∏°‡∏¥ ‡∏¢‡∏±‡∏ô‡∏ï‡∏∞‡∏ö‡∏∏‡∏®‡∏¢‡πå', alignment: 'center', fontSize: 12, margin: [0,0,0,3]},
                        {text: '(‡∏ô‡∏≤‡∏¢‡∏≠‡∏†‡∏¥‡∏£‡∏±‡∏Å‡∏Ç‡∏†‡∏π‡∏°‡∏¥ ‡∏¢‡∏±‡∏ô‡∏ï‡∏∞‡∏ö‡∏∏‡∏®‡∏¢‡πå)', alignment: 'center', fontSize: 12, margin: [0,0,0,3]},
                        {text: '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á ‡∏£‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏®‡∏∂‡∏Å‡∏©‡∏≤', alignment: 'center', fontSize: 12, margin: [0,0,0,3]},
                        {text: `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(approvedDate)}`, alignment: 'center', fontSize: 12, margin: [0,0,0,15]},
                        {text: '‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á', alignment: 'center', bold: true, fontSize: 12, margin: [0,0,0,8]},
                        {text: '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÉ‡∏´‡πâ‡∏•‡∏≤‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠', alignment: 'center', fontSize: 12, margin: [0,0,0,15]},
                        {text: '(‡∏•‡∏á‡∏ä‡∏∑‡πà‡∏≠) ‡∏ô‡∏≤‡∏¢‡πÄ‡∏ó‡∏≠‡∏î‡πÑ‡∏ó‡∏¢  ‡∏´‡∏≠‡∏°‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥', alignment: 'center', fontSize: 12, margin: [0,0,0,3]},
                        {text: '(‡∏ô‡∏≤‡∏¢‡πÄ‡∏ó‡∏≠‡∏î‡πÑ‡∏ó‡∏¢  ‡∏´‡∏≠‡∏°‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥)', alignment: 'center', fontSize: 12, margin: [0,0,0,3]},
                        {text: '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡∏´‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏£‡∏±‡∏á‡∏™‡∏§‡∏©‡∏î‡∏¥‡πå', alignment: 'center', fontSize: 12, margin: [0,0,0,3]},
                        {text: `‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(approvedDate)}`, alignment: 'center', fontSize: 12, margin: [0,0,0,0]}
                    ]
                };

                pdfMake.createPdf(docDefinition).download(`‡πÉ‡∏ö‡∏•‡∏≤_${leave.userName}_${formatThaiDate(approvedDate)}.pdf`);

            } catch (error) {
                console.error('[Teacher] PDF Error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        };

        // Open Edit Leave Modal
        window.openEditLeaveModal = async function(leaveId) {
            try {
                const leaveDoc = await getDoc(doc(db, 'leaves', leaveId));
                if (!leaveDoc.exists()) {
                    alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏•‡∏≤');
                    return;
                }

                const leave = leaveDoc.data();
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÉ‡∏ö‡∏•‡∏≤‡∏¢‡∏±‡∏á‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
                if (leave.status !== '‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥') {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ö‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥');
                    return;
                }

                // ‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                document.getElementById('editLeaveId').value = leaveId;
                document.getElementById('editLeaveType').value = leave.type;
                document.getElementById('editLeaveStartDate').value = leave.startDate;
                document.getElementById('editLeaveEndDate').value = leave.endDate;
                document.getElementById('editLeaveReason').value = leave.reason;
                document.getElementById('editLeavePhone').value = leave.phone || '';

                // ‡πÅ‡∏™‡∏î‡∏á modal
                document.getElementById('editLeaveModal').classList.add('show');
                document.body.style.overflow = 'hidden';
            } catch (error) {
                console.error('Error opening edit modal:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        };

        // Close Edit Leave Modal
        window.closeEditLeaveModal = function() {
            document.getElementById('editLeaveModal').classList.remove('show');
            document.body.style.overflow = '';
            document.getElementById('editLeaveForm').reset();
        };

        // Update Leave
        window.updateLeave = async function() {
            try {
                const leaveId = document.getElementById('editLeaveId').value;
                const type = document.getElementById('editLeaveType').value;
                const startDate = document.getElementById('editLeaveStartDate').value;
                const endDate = document.getElementById('editLeaveEndDate').value;
                const reason = document.getElementById('editLeaveReason').value;
                const phone = document.getElementById('editLeavePhone').value;

                if (!type || !startDate || !endDate || !reason) {
                    alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô');
                    return;
                }

                if (new Date(endDate) < new Date(startDate)) {
                    alert('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤');
                    return;
                }

                const start = new Date(startDate);
                const end = new Date(endDate);
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

                await updateDoc(doc(db, 'leaves', leaveId), {
                    type: type,
                    startDate: startDate,
                    endDate: endDate,
                    days: days,
                    reason: reason,
                    phone: phone,
                    updatedAt: new Date().toISOString()
                });

                alert('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ö‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                closeEditLeaveModal();
                loadLeaveHistory();
                loadLeaveStats();
            } catch (error) {
                console.error('Error updating leave:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        };

        // Cancel Leave
        window.cancelLeave = async function(leaveId) {
            if (!confirm('‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
                return;
            }

            try {
                // Import deleteDoc if not already imported
                const { deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                await deleteDoc(doc(db, 'leaves', leaveId));
                alert('‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡∏•‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
                loadLeaveHistory();
                loadLeaveStats();
            } catch (error) {
                console.error('Error canceling leave:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
            }
        };

        window.showContactPopup = function() {
            const popup = document.getElementById('contactPopup');
            popup.classList.add('show');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
            
            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebarOverlay');
                if (sidebar && overlay) {
                    sidebar.classList.remove('show');
                    overlay.classList.remove('show');
                }
            }
        };

        // Close contact popup
        window.closeContactPopup = function() {
            const popup = document.getElementById('contactPopup');
            popup.classList.remove('show');
            document.body.style.overflow = ''; // Restore scrolling
        };

        // Close popup when clicking on overlay
        window.closeContactPopupOnOverlay = function(event) {
            if (event.target.id === 'contactPopup') {
                closeContactPopup();
            }
        };

        // Check and reset for new fiscal year
        async function checkAndResetFiscalYear() {
            try {
                const currentFY = getFiscalYear();
                console.log('Current fiscal year:', currentFY);
                
                // Get system settings
                const settingsRef = doc(db, 'settings', 'system');
                const settingsDoc = await getDoc(settingsRef);
                const lastResetFY = settingsDoc.exists() ? settingsDoc.data().lastResetFiscalYear : null;

                console.log('Last reset fiscal year:', lastResetFY);

                // Only admin should perform the actual reset, but teacher can check
                if (lastResetFY !== currentFY) {
                    console.log(`New fiscal year ${currentFY} detected. Waiting for admin to perform reset...`);
                }
            } catch (error) {
                console.error('Error checking fiscal year:', error);
            }
        }

        // Initialize
        checkAndResetFiscalYear();
        showFiscalYearNotification();
        loadLeaveStats();
        loadTripStats();
        loadLateStats();
        loadLeaveHistory();
        loadOfficialTripHistory();
        loadLateArrivalHistory();
    </script>

    <!-- Contact Popup -->
    <div class="contact-popup" id="contactPopup" onclick="closeContactPopupOnOverlay(event)">
        <div class="contact-popup-content">
            <div class="contact-popup-header">
                <div class="contact-popup-header-icon">üìû</div>
                <h2>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà</h2>
            </div>
            
            <div class="contact-popup-body">
                <div class="contact-section">
                    <div class="contact-section-title">
                        <span class="contact-section-title-icon">üë•</span>
                        <span>‡πÄ‡∏à‡πâ‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏•‡∏≤</span>
                    </div>
                    
                    <a href="tel:0972342545" class="contact-item">
                        <div class="contact-item-icon">üì±</div>
                        <div class="contact-item-info">
                            <div class="contact-item-name">‡∏Ñ‡∏£‡∏π‡πÄ‡∏≠‡∏∑‡πâ‡∏≠‡∏≠‡∏≤‡∏£‡∏µ ‡πÄ‡∏≠‡∏Å‡∏û‡∏±‡∏ô‡∏ò‡πå</div>
                            <div class="contact-item-phone">097-234-2545</div>
                        </div>
                    </a>
                    
                    <a href="tel:0925070358" class="contact-item">
                        <div class="contact-item-icon">üì±</div>
                        <div class="contact-item-info">
                            <div class="contact-item-name">‡∏Ñ‡∏£‡∏π‡∏ß‡∏¥‡∏†‡∏≤‡∏£‡∏±‡∏ï‡∏ô‡πå ‡∏™‡∏∏‡∏ò‡∏£‡∏£‡∏°</div>
                            <div class="contact-item-phone">092-507-0358</div>
                        </div>
                    </a>
                </div>
                
                <div class="contact-section">
                    <div class="contact-section-title">
                        <span class="contact-section-title-icon">üíª</span>
                        <span>‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢</span>
                    </div>
                    
                    <a href="tel:0933281575" class="contact-item contact-developer">
                        <div class="contact-item-icon">üë®‚Äçüíª</div>
                        <div class="contact-item-info">
                            <div class="contact-item-name">‡∏Ñ‡∏£‡∏π‡∏®‡∏¥‡∏£‡∏¥‡∏®‡∏±‡∏Å‡∏î‡∏¥‡πå ‡∏õ‡∏¥‡∏•‡∏≠‡∏á</div>
                            <div class="contact-item-phone">093-328-1575</div>
                        </div>
                    </a>
                </div>
            </div>
            
            <div class="contact-popup-footer">
                <button class="contact-popup-close-btn" onclick="closeContactPopup()">
                    ‡∏õ‡∏¥‡∏î
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Leave Modal -->
    <div class="edit-modal" id="editLeaveModal">
        <div class="edit-modal-content">
            <div class="edit-modal-header">
                <h2>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏ö‡∏•‡∏≤</h2>
                <button class="edit-modal-close" onclick="closeEditLeaveModal()">√ó</button>
            </div>
            <div class="edit-modal-body">
                <form id="editLeaveForm" class="form-grid">
                    <input type="hidden" id="editLeaveId">
                    
                    <div class="form-group">
                        <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
                        <select id="editLeaveType" class="form-input" required>
                            <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏•‡∏≤ --</option>
                            <option value="‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢">‡∏•‡∏≤‡∏õ‡πà‡∏ß‡∏¢</option>
                            <option value="‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß">‡∏•‡∏≤‡∏Å‡∏¥‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß</option>
                            <option value="‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£">‡∏•‡∏≤‡∏Ñ‡∏•‡∏≠‡∏î‡∏ö‡∏∏‡∏ï‡∏£</option>
                            <option value="‡∏•‡∏≤‡∏≠‡∏∏‡∏õ‡∏™‡∏°‡∏ö‡∏ó">‡∏•‡∏≤‡∏≠‡∏∏‡∏õ‡∏™‡∏°‡∏ö‡∏ó</option>
                            <option value="‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô">‡∏•‡∏≤‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤</label>
                        <input type="date" id="editLeaveStartDate" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                        <input type="date" id="editLeaveEndDate" class="form-input" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤</label>
                        <textarea id="editLeaveReason" class="form-input" rows="4" required placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤..."></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏•‡∏≤</label>
                        <input type="tel" id="editLeavePhone" class="form-input" placeholder="089-xxx-xxxx">
                    </div>
                </form>
            </div>
            <div class="edit-modal-footer">
                <button type="button" class="btn" style="background: #6b7280;" onclick="closeEditLeaveModal()">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button type="button" class="btn" style="background: #2563eb;" onclick="updateLeave()">
                    üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
                </button>
            </div>
        </div>
    </div>
</body>
</html>
